# frozen_string_literal: true

require "rails_helper"

RSpec.describe CareCases::ChatsController do
  describe "GET /care_cases/:care_case_id/chats" do
    before do
      stub_sendbird
    end

    context "when the staffer is authorized" do
      context "with no chat setup" do
        it "renders without error and shows empty chat interface" do
          caregiver = FactoryBot.create(:member, :with_personal_information)
          patient = FactoryBot.create(:member, :registered)
          coach = FactoryBot.create(:staffer, :coach, :with_bio)
          account = FactoryBot.create(:account, :setup_completed, assigned_coach: coach, caregivers: [caregiver], children: [patient])
          care_case = FactoryBot.create(:care_case, :in_treatment, account: account, caregivers: [caregiver], patient: patient, program: Program.therapy)

          log_in_as_staffer(coach)

          get care_case_chats_path(care_case)

          expect(response).to have_http_status(:ok)
          expect(response.body).to include("Chat with")
          expect(response.body).not_to include("#{caregiver.first_name} (caregiver)")
        end
      end

      describe "with invalid tab parameter" do
        it "defaults to caregiver tab when tab is invalid" do
          generator = Generators::NewAccount.hooked_up_for_chat
          log_in_as_staffer(generator.account.assigned_coach)

          get care_case_chats_path(generator.care_case), params: {tab: "appointments"}

          expect(response).to have_http_status(:ok)
          expect(response.body).to include("(caregiver)")
        end

        it "defaults to caregiver tab when tab is nil" do
          generator = Generators::NewAccount.hooked_up_for_chat
          log_in_as_staffer(generator.account.assigned_coach)

          get care_case_chats_path(generator.care_case)

          expect(response).to have_http_status(:ok)
          expect(response.body).to include("(caregiver)")
        end
      end

      describe "with valid tab parameter" do
        it "uses caregiver tab when specified" do
          generator = Generators::NewAccount.hooked_up_for_chat
          log_in_as_staffer(generator.account.assigned_coach)

          get care_case_chats_path(generator.care_case), params: {tab: "caregiver"}

          expect(response).to have_http_status(:ok)
          expect(response.body).to include("(caregiver)")
        end

        it "uses teen tab when specified for a teen case" do
          generator = Generators::NewAccount.hooked_up_for_chat(with_teen: true)
          log_in_as_staffer(generator.account.assigned_coach)

          get care_case_chats_path(generator.care_case), params: {tab: "teen"}

          expect(response).to have_http_status(:ok)
          expect(response.body).to include("(teen)")
        end
      end

      describe "spectator access" do
        it "shows all accessible chats for spectator staffers regardless of care case" do
          caregiver = FactoryBot.create(:member, :with_personal_information, :with_login, :with_sendbird_user)
          patient = FactoryBot.create(:member, :registered)
          spectator_staffer = FactoryBot.create(:staffer, :manager)
          spectator_sendbird_user = Chat::SpectatorParticipant.sendbird_user_with_fewest_memberships
          account = FactoryBot.create(:account, :setup_completed, caregivers: [caregiver], children: [patient])

          care_case_a = FactoryBot.create(:care_case, :in_treatment, account: account, caregivers: [caregiver], patient: patient, program: Program.therapy)
          care_case_b = FactoryBot.create(:care_case, :in_treatment, account: account, caregivers: [caregiver], patient: patient, program: Program.therapy)

          FactoryBot.create(
            :sendbird_chat_channel, :therapist,
            account: account,
            care_case: care_case_a,
            sendbird_users: [caregiver.sendbird_user, spectator_sendbird_user]
          )

          log_in_as_staffer(spectator_staffer)

          get care_case_chats_path(care_case_b), params: {tab: "caregiver"}

          expect(response).to have_http_status(:ok)
          expect(response.body).to include(caregiver.first_name)
        end
      end
    end
  end
end
