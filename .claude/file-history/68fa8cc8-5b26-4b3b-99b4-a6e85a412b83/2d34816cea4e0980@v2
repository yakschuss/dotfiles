# frozen_string_literal: true

module Staffers
  module CoachWorkflows
    class ChatChannelComponent < ViewComponent::Base
      attr_reader :accessible_staffer_channel, :current_staffer
      delegate :unread_messages?, :chat_path, :staffer_responded_to_last_message?, :last_message_sent_at, :overdue?, :last_message_content, :starred?, :flagged_as_safety_risk?, to: :accessible_staffer_channel

      def initialize(accessible_staffer_channel:, current_staffer:, on_starred_tab: false)
        @accessible_staffer_channel = accessible_staffer_channel
        @current_staffer = current_staffer
        @on_starred_tab = on_starred_tab
      end

      def on_starred_tab?
        @on_starred_tab
      end

      def formatted_last_message_content
        if staffer_responded_to_last_message?
          tag.em("You (#{last_message_sent_at_time}):", class: "mr-2") + last_message_content
        else
          tag.em("(#{last_message_sent_at_time}) ", class: "mr-2") + last_message_content
        end
      end

      def last_message_sent_at_time
        Time.use_zone(current_staffer.timezone) do
          if last_message_sent_at.today?
            l(last_message_sent_at, format: :reef_chat_design_format_time_only)
          else
            l(last_message_sent_at, format: :reef_chat_design_format_time_and_date)
          end
        end
      end

      def formatted_last_message_sent_at
        return "" unless last_message_sent_at.present?

        time_ago_in_words(last_message_sent_at, scope: "datetime.distance_in_words.compass_left_panel")
      end
    end
  end
end
