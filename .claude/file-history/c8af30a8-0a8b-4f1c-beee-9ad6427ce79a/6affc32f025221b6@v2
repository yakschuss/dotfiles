# frozen_string_literal: true

require "rails_helper"

RSpec.describe CareCases::AppointmentSlotsController do
  include AhoyHelpers

  before do
    CoverageContextMocks.ongoing_appointment_scheduling(stub_factory_method: true)
  end

  describe "GET /care_cases/:care_case_id/appointment_slots" do
    it "renders successfully with a turbo-frame for the weekly calendar" do
      patient = FactoryBot.create(:member, timezone: "Central Time (US & Canada)")
      staffer = FactoryBot.create(:staffer, :therapist, timezone: "Eastern Time (US & Canada)", therapy_regions: [Region.us])
      account = FactoryBot.create(:account, region: Region.washington)
      care_case = FactoryBot.create(:care_case, patient: patient, program: Program.therapy, primary_staffer: staffer, account: account)

      log_in_as_admin

      get care_case_appointment_slots_path(care_case)

      expect(CoverageContext).to have_received(:ongoing_appointment_scheduling)
        .with(care_case, RootAppointmentType.therapy_session.service_line)

      expect(response).to be_successful
      src = Addressable::URI.escape("/care_cases/#{care_case.id}/appointment_slots/weekly_calendar?filters[appointment_duration]=55&filters[root_appointment_type_id]=therapy_session&filters[staffer_id]=#{staffer.id}")
      expect(response.body).to have_selector("turbo-frame#weekly_calendar[src='#{src}']")
    end

    it "shows coaching appointment types for blk member" do
      account = FactoryBot.create(:account, region: Region.california)
      patient = FactoryBot.create(:member, timezone: "Pacific Time (US & Canada)", initial_age: 7)
      staffer = FactoryBot.create(:staffer, :coach, timezone: "Pacific Time (US & Canada)", coaching_regions: [Region.us])
      other_staffer = FactoryBot.create(:staffer, :coach, timezone: "Pacific Time (US & Canada)", coaching_regions: [Region.us])
      care_case = FactoryBot.create(:care_case, patient: patient, account: account)

      member_support = FactoryBot.create(:staffer, :member_support)
      log_in_as_staffer(member_support)

      get care_case_appointment_slots_path(care_case)

      expect(response).to be_successful
      expect(response.body).to have_content(RootAppointmentType.coaching_session.internal_name)
      expect(response.body).to have_content(staffer.full_name_and_role)
      expect(response.body).to have_content(other_staffer.full_name_and_role)
    end

    context "when the care case has care guide program and no primary staffer" do
      it "renders successfully" do
        account = FactoryBot.create(:account, region: Region.california)
        patient = FactoryBot.create(:member, timezone: "Central Time (US & Canada)")
        FactoryBot.create(:staffer, :coach, timezone: "Eastern Time (US & Canada)", coaching_regions: [Region.us])
        care_case = FactoryBot.create(:care_case, patient: patient, program: Program.care_guide, account: account)

        log_in_as_admin

        get care_case_appointment_slots_path(care_case)

        expect(CoverageContext).to have_received(:ongoing_appointment_scheduling)
          .with(care_case, RootAppointmentType.coaching_session.service_line)

        expect(response).to be_successful
      end
    end

    context "when staffer has the care capability for" do
      context "therapist in New York" do
        it "shows relevant appointment types and staffers for clinic" do
          clinic = FactoryBot.create(:clinic, address_state: Region.new_york.short_name)
          account = FactoryBot.create(:account, region: Region.new_york)
          patient = FactoryBot.create(:member, timezone: "Central Time (US & Canada)", initial_age: 7)
          staffer = FactoryBot.create(:staffer, :therapist, timezone: "Eastern Time (US & Canada)", therapy_regions: [Region.us], clinic: clinic)
          other_staffer = FactoryBot.create(:staffer, :therapist, timezone: "Eastern Time (US & Canada)", therapy_regions: [Region.us])
          care_case = FactoryBot.create(:care_case, patient: patient, program: Program.therapy, primary_staffer: staffer, account: account)

          log_in_as_staffer(staffer)

          get care_case_appointment_slots_path(care_case)

          expect(response).to be_successful
          expect(response.body).to have_content("Clinic")
          expect(response.body).to have_content(RootAppointmentType.therapy_session.internal_name)
          expect(response.body).not_to have_content(RootAppointmentType.coaching_session.internal_name)
          expect(response.body).to have_content(staffer.full_name_and_role)
          expect(response.body).not_to have_content(other_staffer.full_name_and_role)
        end
      end

      context "coaching" do
        it "shows relevant appointment types" do
          account = FactoryBot.create(:account, region: Region.california)
          patient = FactoryBot.create(:member, timezone: "Central Time (US & Canada)", initial_age: 7)
          staffer = FactoryBot.create(:staffer, :coach, timezone: "Eastern Time (US & Canada)")
          other_staffer = FactoryBot.create(:staffer, :coach, timezone: "Eastern Time (US & Canada)")
          care_case = FactoryBot.create(:care_case, patient:, program: Program.general_coaching, primary_staffer: staffer, account: account)

          log_in_as_staffer(staffer)

          get care_case_appointment_slots_path(care_case)

          expect(response).to be_successful
          expect(response.body).to have_content(RootAppointmentType.coaching_session.internal_name)
          expect(response.body).not_to have_content(RootAppointmentType.therapy_session.internal_name)
          expect(response.body).not_to have_content(RootAppointmentType.therapy_session_legacy.internal_name)
          expect(response.body).to have_content(staffer.full_name_and_role)
          expect(response.body).not_to have_content(other_staffer.full_name_and_role)
        end
      end

      context "coaching for autism" do
        it "shows relevant appointment types" do
          account = FactoryBot.create(:account, region: Region.california)
          patient = FactoryBot.create(:member, timezone: "Central Time (US & Canada)", initial_age: 7)
          staffer = FactoryBot.create(:staffer, :autism_spectrum_disorder_coach, timezone: "Eastern Time (US & Canada)")
          other_staffer = FactoryBot.create(:staffer, :autism_spectrum_disorder_coach, timezone: "Eastern Time (US & Canada)")
          care_case = FactoryBot.create(:care_case, patient:, program: Program.autism_spectrum_disorder_coaching, primary_staffer: staffer, account: account)

          log_in_as_staffer(staffer)

          get care_case_appointment_slots_path(care_case)

          expect(response).to be_successful
          expect(response.body).to have_content(RootAppointmentType.autism_spectrum_disorder_coaching_session.internal_name)
          expect(response.body).not_to have_content(RootAppointmentType.therapy_session_legacy.internal_name)
          expect(response.body).to have_content(staffer.full_name_and_role)
          expect(response.body).not_to have_content(other_staffer.full_name_and_role)
        end
      end
    end
  end
end
