# frozen_string_literal: true

module Staffers
  module Accounts
    module Members
      class MemberTabsComponent < ViewComponent::Base
        include TabHelpers

        attr_reader :account, :member, :staffer, :tab

        def initialize(account:, member:, staffer:, tab: "overview")
          @account = account
          @member = member
          @staffer = staffer
          @tab = tab
        end

        def tab_items
          [
            build_tab_item({name: "Member overview", param: "overview", link: {href: account_member_path(account, member)}}),
            build_tab_item({name: "App usage", param: "app_usage", link: {href: account_member_connect_usage_path(account, member)}}),
            *chat_tabs,
            outreach_tab
          ].compact
        end

        private

        def chat_tabs
          sorted_channels = Chat::AccessibleStafferChannel.for(account: account, staffer: staffer, member: member, prefer_unmuted: true)

          sorted_channels.map do |accessible_channel|
            tab_name = accessible_channel.short_name
            tab_name += " <span class='badge badge-info'>Deactivated</span>" if accessible_channel.deactivated?

            build_tab_item({
              name: sanitize(tab_name),
              param: accessible_channel.parameterized_name,
              link: {href: accessible_channel.path},
              display_notification: accessible_channel.unread_messages?,
              data: {turbo: false, turbolinks: false}
            })
          end
        end

        def outreach_tab
          return unless ::Accounts::Members::OutreachPolicy.new(staffer, account).show?

          build_tab_item({name: "Outreach", param: "outreach", link: {href: account_member_outreach_path(account, member)}})
        end

        def account_member
          @_account_member ||= AccountMember.new(account: account, member: member)
        end
      end
    end
  end
end
