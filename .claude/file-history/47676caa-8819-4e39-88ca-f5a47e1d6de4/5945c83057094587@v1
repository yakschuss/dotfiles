# frozen_string_literal: true

require "rails_helper"

RSpec.describe SlotRecapture::ConfigurationData do
  describe "default attributes" do
    it "has default weight values" do
      data = described_class.new

      expect(data.weight_same_provider).to eq(0.4)
      expect(data.weight_clinic_match).to eq(0.25)
      expect(data.weight_exact_type).to eq(0.15)
      expect(data.weight_priority).to eq(0.1)
      expect(data.weight_wait_time).to eq(0.1)
    end

    it "has default threshold values" do
      data = described_class.new

      expect(data.lead_time_hours_minimum).to eq(24)
      expect(data.wait_time_cap_days).to eq(90)
      expect(data.matches_per_opportunity).to eq(5)
    end

    it "has default matching rule values" do
      data = described_class.new

      expect(data.empty_clinic_ids_means_any).to eq(true)
      expect(data.clinic_mismatch_excludes).to eq(false)
      expect(data.same_provider_check).to eq("primary_only")
    end

    it "has default behavior values" do
      data = described_class.new

      expect(data.auto_detect_filled).to eq(true)
      expect(data.allow_reopen_after_outreach_expires).to eq(true)
    end
  end

  describe "#weights" do
    it "returns a hash of all weights" do
      data = described_class.new

      expect(data.weights).to eq({
        same_provider: 0.4,
        clinic_match: 0.25,
        exact_type: 0.15,
        priority: 0.1,
        wait_time: 0.1
      })
    end
  end

  describe "#weights_valid?" do
    it "returns true when weights sum to 1.0" do
      data = described_class.new

      expect(data.weights_valid?).to eq(true)
    end

    it "returns true when weights sum to approximately 1.0" do
      data = described_class.new(
        weight_same_provider: 0.33,
        weight_clinic_match: 0.34,
        weight_exact_type: 0.11,
        weight_priority: 0.11,
        weight_wait_time: 0.11
      )

      expect(data.weights_valid?).to eq(true)
    end

    it "returns false when weights do not sum to 1.0" do
      data = described_class.new(
        weight_same_provider: 0.5,
        weight_clinic_match: 0.5,
        weight_exact_type: 0.15,
        weight_priority: 0.1,
        weight_wait_time: 0.1
      )

      expect(data.weights_valid?).to eq(false)
    end
  end

  describe "custom attribute values" do
    it "accepts custom weight values" do
      data = described_class.new(
        weight_same_provider: 0.5,
        weight_clinic_match: 0.2
      )

      expect(data.weight_same_provider).to eq(0.5)
      expect(data.weight_clinic_match).to eq(0.2)
    end

    it "accepts custom threshold values" do
      data = described_class.new(
        lead_time_hours_minimum: 48,
        matches_per_opportunity: 10
      )

      expect(data.lead_time_hours_minimum).to eq(48)
      expect(data.matches_per_opportunity).to eq(10)
    end
  end
end
