# frozen_string_literal: true

module SlotRecapture
  class FilledDetector
    include EventSystem::Listener

    on(AppointmentScheduledEvent) do |event|
      return unless Flipper.enabled?(:slot_recapture_enabled)
      return unless Configuration.current.data.auto_detect_filled

      new.handle(event)
    end

    def handle(event)
      appointment = event.appointment

      # Find matching opportunity by staffer + start_time (within 1 minute tolerance)
      opportunity = Opportunity
        .where(status: [Opportunity::Status.open, Opportunity::Status.offered])
        .where(staffer_id: appointment.staffer_id)
        .where(start_time: (appointment.start_time - 1.minute)..(appointment.start_time + 1.minute))
        .first

      return unless opportunity

      opportunity.filled!
      Rails.logger.info("[SlotRecapture] Opportunity #{opportunity.id} marked as filled")
    end
  end
end
