# frozen_string_literal: true

carol = Member.find_by(first_name: 'Carol', last_name: 'McCormick')
puts "=== CAROL'S DATA ==="
puts "Carol ID: #{carol.id}"
account = carol.accounts.first
puts "Account ID: #{account.id}"
puts ""

puts "=== CARE CASES ==="
care_cases = carol.care_cases.to_a
care_cases.each_with_index do |cc, i|
  puts "Care Case #{i+1}: #{cc.id}"
end
puts "Total: #{care_cases.count}"
puts ""

puts "=== SENDBIRD CHAT CHANNELS FOR ACCOUNT ==="
channels = SendbirdChatChannel.where(account: account)
puts "Total channels: #{channels.count}"
puts ""

channels.each do |channel|
  puts "Channel: #{channel.id}"
  puts "  Type: #{channel.chat_type}"
  puts "  Care case ID: #{channel.care_case_id || 'NONE'}"
  puts "  Memberships: #{channel.memberships.count}"

  channel.memberships.each do |membership|
    user = membership.sendbird_user
    puts "    - SendbirdUser #{user.id}: #{user.nickname}"

    # Check if this sendbird user belongs to a staffer
    staffer = SendbirdUser.find(user.id).staffer rescue nil
    if staffer
      puts "      → Staffer: #{staffer.full_name} (#{staffer.role})"
    end
  end
  puts ""
end

puts "=== WHAT'S NEEDED FOR TESTING ==="
puts "For the 'Care case' dropdown to show on account member page:"
puts "1. Carol needs to be in 2+ care cases ✓ (has #{care_cases.count})"
puts "2. Same COACH needs to have chat channels with Carol across DIFFERENT care cases"
puts "3. Each chat channel needs care_case_id set"
puts ""

puts "=== CURRENT ISSUES ==="
issues = []
channels.each do |channel|
  if channel.care_case_id.blank?
    issues << "Channel #{channel.id} (#{channel.chat_type}) has NO care_case_id"
  end
end

coach_channels_by_care_case = {}
channels.where(chat_type: Chat::Type.coach).each do |channel|
  next if channel.care_case_id.blank?

  channel.memberships.each do |membership|
    user = membership.sendbird_user
    staffer = SendbirdUser.find(user.id).staffer rescue nil
    next unless staffer&.role == 'coach'

    coach_channels_by_care_case[staffer.id] ||= {}
    coach_channels_by_care_case[staffer.id][channel.care_case_id] = true
  end
end

# Check if any coach has chats in multiple care cases
coaches_with_multiple_care_cases = coach_channels_by_care_case.select { |_, care_cases| care_cases.keys.count > 1 }

if coaches_with_multiple_care_cases.empty?
  issues << "No coach has chat channels across multiple care cases for Carol"
end

if issues.any?
  puts issues.join("\n")
else
  puts "Data looks correct!"
end
