# frozen_string_literal: true

module SlotRecapture
  class Opportunity < ApplicationRecord
    include StateMachine

    belongs_to :cancelled_appointment, class_name: "Appointment"
    belongs_to :staffer
    belongs_to :clinic
    has_many :outreach_attempts, class_name: "WaitList::OutreachAttempt", foreign_key: :slot_recapture_opportunity_id

    Status = Enum.new(%w[pending_verification open offered filled expired ineligible])

    enum :status, Status.as_string_map, default: Status.pending_verification

    state_machine :status do
      from Status.pending_verification, to: [Status.open, Status.ineligible]
      from Status.open, to: [Status.offered, Status.filled, Status.expired]
      from Status.offered, to: [Status.filled, Status.open, Status.expired]
    end

    scope :actionable, -> { where(status: [Status.open, Status.offered]) }
    scope :pending, -> { where(status: Status.pending_verification) }
    scope :by_start_time, -> { order(:start_time) }

    validates :cancelled_appointment_id, uniqueness: true

    def hours_until_start
      ((start_time - Time.current) / 1.hour).round
    end

    def active_outreach_attempt
      outreach_attempts.active.first
    end
  end
end
