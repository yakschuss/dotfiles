# frozen_string_literal: true

module Onboarding
  class EnsureTeenInvited
    include EventSystem::Listener

    attr_accessor :care_case
    include Invokable

    invokable_via :process

    on(RegistrationCompletedEvent) do |event|
      process(care_case: event.care_case)
    end

    on(AccountSetupCompletedEvent) do |event|
      # If a care case has an appointment scheduled, invite the teen for that case now
      # as they would not have been invited before.
      event.account.care_cases.each do |care_case|
        next unless care_case.appointments.scheduled.exists?
        process(care_case: care_case)
      end
    end

    def initialize(care_case:)
      @care_case = care_case
    end

    def process
      # If account owner not yet registered, we wait to invite the teen until they do.
      return unless care_case.account.owner.registered?
      return unless is_teen_case?

      if email.present?
        handle_email_present
      else
        handle_email_missing
      end
    end

    private

    def handle_email_present
      TeenRegistration.new(care_case: care_case).process
    end

    def handle_email_missing
      send_chat_to_caregiver
      send_reminder_to_ms
    end

    def send_chat_to_caregiver
      Chat::AutomatedMessage.send!(
        sendbird_chat_channel: sendbird_chat_channel,
        sending_user: member_support_user,
        text: text
      )
    end

    def send_reminder_to_ms
      TaskManagement::Reminder.find_or_create_by!(
        title: "Check MS chat to see if the caregiver responded with the teen's email. If not, send additional message to the caregiver to request teen's email",
        group: :member_support,
        care_case: care_case,
        account: care_case.account,
        subject: care_case,
        completed_at: nil
      ) do |reminder|
        reminder.due_date = (Time.zone.now + 24.hours).to_date
        reminder.priority = "medium"
      end
    end

    def email
      @email ||= care_case.patient.email
    end

    def text
      <<~EOS
        Hi #{care_case.caregiver.first_name},\n
          Teens at Brightline have access to their own account where they can complete digital exercises, activities, and progress trackers.\n
          Can you please provide #{care_case.patient_preferred_name}'s email address? We'll send them an email inviting them to the Brightline web app.\n
          Thanks and I hope to hear from you soon!
      EOS
    end

    def sendbird_chat_channel
      @sendbird_chat_channel ||= SendbirdChatChannel.member_support_channel_for(account: care_case.account, member: care_case.caregiver)
    end

    def member_support_user
      @member_support_user ||= Chat::MemberSupportParticipant.sendbird_user_in_channel(sendbird_chat_channel)
    end

    def is_teen_case?
      ::Rules::CareCase::TeenCase.call(care_case)
    end
  end
end
