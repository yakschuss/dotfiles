#!/bin/bash
# Git worktree helper
# Usage:
#   gwt branch-name [base]   Create new branch from base (default: main)
#   gwt -e branch-name       Add existing branch to worktree
#   gwt -l                   List all worktrees
#   gwt -r branch-name       Remove worktree
#   gwt -p                   Prune broken worktrees

set -e

WORKTREE_DIR=".worktrees"

usage() {
    echo "Usage:"
    echo "  gwt branch-name [base]   Create new branch from base (default: main)"
    echo "  gwt -e branch-name       Add existing branch to worktree"
    echo "  gwt -l                   List all worktrees"
    echo "  gwt -r branch-name       Remove worktree"
    echo "  gwt -p                   Prune broken worktrees"
    echo "  gwt -h                   Show this help"
    exit "${1:-0}"
}

[[ $# -eq 0 ]] && usage 1

case "$1" in
    -h|--help)
        usage
        ;;
    -e)
        [[ -z "$2" ]] && usage 1
        git worktree add "$WORKTREE_DIR/$2" "$2"
        echo "Created worktree at $WORKTREE_DIR/$2"
        ;;
    -l)
        git worktree list
        ;;
    -r)
        [[ -z "$2" ]] && usage 1
        git worktree remove "$WORKTREE_DIR/$2"
        echo "Removed worktree $WORKTREE_DIR/$2"
        ;;
    -p)
        git worktree prune
        echo "Pruned broken worktrees"
        ;;
    -*)
        usage 1
        ;;
    *)
        branch="$1"
        base="${2:-main}"
        git worktree add "$WORKTREE_DIR/$branch" -b "$branch" "$base"
        echo "Created worktree at $WORKTREE_DIR/$branch (branched from $base)"
        ;;
esac
