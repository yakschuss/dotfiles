# frozen_string_literal: true

# Setup Carol McCormick with therapist chats across multiple care cases

carol = Member.find_by(first_name: 'Carol', last_name: 'McCormick')

unless carol
  puts 'Carol McCormick not found!'
  exit
end

puts "Setting up therapist test data for Carol McCormick (#{carol.id})"
account = carol.accounts.first

unless account
  puts 'No account found for Carol!'
  exit
end

care_cases = carol.care_cases.to_a
puts "Carol has #{care_cases.count} care cases"

if care_cases.count < 2
  puts "ERROR: Carol needs at least 2 care cases but only has #{care_cases.count}"
  exit
end

care_case_1 = care_cases[0]
care_case_2 = care_cases[1]

puts "Care Case 1: #{care_case_1.id}"
puts "Care Case 2: #{care_case_2.id}"
puts ''

# Find a therapist via care capability
therapy_care_capability = CareCapability.find_by(capability_id: 'therapy')

unless therapy_care_capability
  puts "ERROR: No therapy care capability found in the system"
  exit
end

therapist = therapy_care_capability.staffer

puts "Using therapist: #{therapist.full_name}"
puts ''

# Ensure therapist has a sendbird user
therapist_sendbird_user = SendbirdUser.where(participant: therapist).first_or_create! do |su|
  su.nickname = therapist.full_name
  su.role = Chat::Role.staffer
end

# Ensure Carol has a sendbird user
unless carol.sendbird_user
  carol.create_sendbird_user!(
    nickname: carol.full_name,
    sendbird_user_id: "member_#{carol.id}_#{SecureRandom.hex(4)}"
  )
  puts "Created sendbird user for Carol"
end

puts "Creating therapist chat channels..."

# Create or update therapist chat for care case 1
chat_id_1 = Chat::ChannelId.therapist(member: carol, care_case: care_case_1, staffer: therapist)
channel_1 = SendbirdChatChannel.find_or_initialize_by(chat_id: chat_id_1)

if channel_1.new_record?
  channel_1.account = account
  channel_1.care_case = care_case_1
  channel_1.chat_type = Chat::Type.therapist
  channel_1.save!
  puts "  Created therapist channel for care case 1"
else
  puts "  Found existing therapist channel for care case 1"
end

# Create memberships for channel 1
SendbirdChatChannelMembership.find_or_create_by!(
  sendbird_chat_channel: channel_1,
  sendbird_user: carol.sendbird_user
).update!(last_message_sent_at: 1.hour.ago)

SendbirdChatChannelMembership.find_or_create_by!(
  sendbird_chat_channel: channel_1,
  sendbird_user: therapist_sendbird_user
).update!(last_message_sent_at: 30.minutes.ago)

puts "    Added memberships with timestamps"

# Create or update therapist chat for care case 2
chat_id_2 = Chat::ChannelId.therapist(member: carol, care_case: care_case_2, staffer: therapist)
channel_2 = SendbirdChatChannel.find_or_initialize_by(chat_id: chat_id_2)

if channel_2.new_record?
  channel_2.account = account
  channel_2.care_case = care_case_2
  channel_2.chat_type = Chat::Type.therapist
  channel_2.save!
  puts "  Created therapist channel for care case 2"
else
  puts "  Found existing therapist channel for care case 2"
end

# Create memberships for channel 2
SendbirdChatChannelMembership.find_or_create_by!(
  sendbird_chat_channel: channel_2,
  sendbird_user: carol.sendbird_user
).update!(last_message_sent_at: 2.hours.ago)

SendbirdChatChannelMembership.find_or_create_by!(
  sendbird_chat_channel: channel_2,
  sendbird_user: therapist_sendbird_user
).update!(last_message_sent_at: 1.hour.ago)

puts "    Added memberships with timestamps"
puts ''

puts "âœ“ Test data created successfully!"
puts ''
puts "Therapist #{therapist.full_name} now has chat channels with Carol across 2 care cases:"
puts "  - Care Case 1 (#{care_case_1.id}): #{channel_1.id}"
puts "  - Care Case 2 (#{care_case_2.id}): #{channel_2.id}"
puts ''
puts "Test URLs:"
puts "  Account Member Page: http://reef.dev-hellobrightline.com:3000/accounts/#{account.id}/members/#{carol.id}/chats/#{channel_1.id}?sendbird_user_id=#{therapist_sendbird_user.id}"
puts ''
puts "On this page, the 'Care case' dropdown should now appear!"
