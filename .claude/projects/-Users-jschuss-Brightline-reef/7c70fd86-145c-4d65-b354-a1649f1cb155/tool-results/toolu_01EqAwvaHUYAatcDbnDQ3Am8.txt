     1→# frozen_string_literal: true
     2→
     3→# == Schema Information
     4→#
     5→# Table name: appointment_cancelations
     6→#
     7→#  id                      :uuid             not null, primary key
     8→#  canceled_at             :datetime         not null
     9→#  canceled_by             :string           not null
    10→#  late                    :boolean          default(FALSE), not null
    11→#  late_cancelation_reason :string
    12→#  notes                   :string
    13→#  reason                  :string
    14→#  trigger_type            :string
    15→#  created_at              :datetime         not null
    16→#  updated_at              :datetime         not null
    17→#  appointment_id          :uuid             not null
    18→#  reason_category_id      :string
    19→#  submitted_by_id         :uuid
    20→#  trigger_id              :uuid
    21→#
    22→# Indexes
    23→#
    24→#  index_appointment_cancelations_on_appointment_id   (appointment_id)
    25→#  index_appointment_cancelations_on_submitted_by_id  (submitted_by_id)
    26→#  index_appointment_cancelations_on_trigger          (trigger_type,trigger_id)
    27→#
    28→# Foreign Keys
    29→#
    30→#  fk_rails_...  (appointment_id => appointments.id)
    31→#  fk_rails_...  (submitted_by_id => staffers.id)
    32→#
    33→class AppointmentCancelation < ApplicationRecord
    34→  belongs_to :appointment
    35→  belongs_to :submitted_by, class_name: "Staffer", optional: true
    36→  belongs_to :trigger, polymorphic: true, optional: true
    37→
    38→  validates :canceled_by, presence: true
    39→  validates :late_cancelation_reason,
    40→    presence: {if: :late?, message: "should be present when late"},
    41→    absence: {unless: :late?, message: "should not be present unless late"}
    42→
    43→  before_save :set_canceled_at, :set_reason_category_id
    44→
    45→  CANCELED_BY = {
    46→    coach: "coach",
    47→    member: "member",
    48→    provider: "provider",
    49→    member_support: "member support",
    50→    therapist: "therapist",
    51→    contractor_therapist: "BC therapist",
    52→    prescriber: "prescriber",
    53→    system: "system",
    54→    care_guide: "care guide"
    55→  }.with_indifferent_access
    56→
    57→  enum :canceled_by, CANCELED_BY, prefix: true
    58→
    59→  LATE_CANCELATION_REASONS = {
    60→    member_initiated_valid: "member_initiated_valid",
    61→    member_initiated_invalid: "member_initiated_invalid",
    62→    provider_initiated_valid: "provider_initiated_valid"
    63→  }.with_indifferent_access
    64→
    65→  enum :late_cancelation_reason, LATE_CANCELATION_REASONS.keys.index_by(&:itself)
    66→
    67→  enum :reason, CancelationReason.ids.map { |id| [id.to_s, id.to_s] }.to_h
    68→
    69→  def humanized_canceled_by
    70→    CANCELED_BY[canceled_by]
    71→  end
    72→
    73→  def invalid_late_cancelation?
    74→    canceled_by == "member" && late? && late_cancelation_reason == "member_initiated_invalid"
    75→  end
    76→
    77→  def cancelation_reason
    78→    CancelationReason.find(reason)&.text
    79→  end
    80→
    81→  private
    82→
    83→  def non_member_cancelation?
    84→    late? && !canceled_by_member?
    85→  end
    86→
    87→  def set_canceled_at
    88→    self.canceled_at ||= Time.zone.now
    89→  end
    90→
    91→  def set_reason_category_id
    92→    self.reason_category_id ||= CancelationReason.find(reason)&.category_id
    93→  end
    94→end
    95→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
