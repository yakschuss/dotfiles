# frozen_string_literal: true

require "rails_helper"

RSpec.describe Calendaring::TemplateBlockTypeService do
  describe ".create" do
    context "min_booking_window_hours calculation" do
      it "converts 0 days to 4 hours" do
        form_params = build_form_params(
          root_appointment_type_id: "therapy_session",
          min_booking_window_days: 0,
          max_booking_window_days: 60
        )

        result = described_class.create(form_params)

        expect(result).to be_success
        appointment_type = result.value.template_block_type_appointment_types.first
        expect(appointment_type.min_booking_window_hours).to eq(4)
      end

      it "converts non-zero days to hours normally" do
        form_params = build_form_params(
          root_appointment_type_id: "therapy_session",
          min_booking_window_days: 2,
          max_booking_window_days: 60
        )

        result = described_class.create(form_params)

        expect(result).to be_success
        appointment_type = result.value.template_block_type_appointment_types.first
        expect(appointment_type.min_booking_window_hours).to eq(48)
      end
    end
  end

  def build_form_params(root_appointment_type_id:, min_booking_window_days:, max_booking_window_days:)
    root_appointment_type = RootAppointmentType.find(root_appointment_type_id)
    duration = root_appointment_type.duration_options.first

    {
      name: "Test Block Type",
      duration_minutes: 60,
      color: "blue",
      appointment_types: {
        "0" => {
          root_appointment_type_id: root_appointment_type_id,
          duration_minutes: duration,
          mode_selection: root_appointment_type.modes.first,
          min_booking_window_days: min_booking_window_days,
          max_booking_window_days: max_booking_window_days,
          offsets: [0]
        }
      }
    }
  end
end
