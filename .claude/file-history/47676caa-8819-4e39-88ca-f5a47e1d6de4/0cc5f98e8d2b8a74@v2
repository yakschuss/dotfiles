# frozen_string_literal: true

require "rails_helper"

describe "SlotRecapture::Opportunities" do
  before do
    Flipper.enable(:slot_recapture_enabled)
    log_in_as_staffer(FactoryBot.create(:staffer, :care_guide))
  end

  after do
    Flipper.disable(:slot_recapture_enabled)
  end

  describe "GET #index" do
    it "returns successful response" do
      get slot_recapture_opportunities_path

      expect(response).to be_successful
    end

    it "displays actionable opportunities" do
      opportunity = FactoryBot.create(:slot_recapture_opportunity, :open)

      get slot_recapture_opportunities_path

      expect(response.body).to include(opportunity.staffer.full_name)
    end

    it "returns 404 when feature flag is disabled" do
      Flipper.disable(:slot_recapture_enabled)

      get slot_recapture_opportunities_path

      expect(response).to have_http_status(:not_found)
    end
  end

  describe "GET #show" do
    it "returns successful response" do
      opportunity = FactoryBot.create(:slot_recapture_opportunity, :open)

      get slot_recapture_opportunity_path(opportunity)

      expect(response).to be_successful
    end

    it "displays opportunity details" do
      opportunity = FactoryBot.create(:slot_recapture_opportunity, :open)

      get slot_recapture_opportunity_path(opportunity)

      expect(response.body).to include(opportunity.staffer.full_name)
    end

    it "shows waitlist matches" do
      opportunity = FactoryBot.create(:slot_recapture_opportunity, :open)

      get slot_recapture_opportunity_path(opportunity)

      expect(response).to be_successful
    end
  end

  describe "PATCH #filled" do
    it "marks opportunity as filled" do
      opportunity = FactoryBot.create(:slot_recapture_opportunity, :offered)

      patch filled_slot_recapture_opportunity_path(opportunity)

      opportunity.reload
      expect(opportunity.status).to eq("filled")
    end

    it "redirects to index after marking as filled" do
      opportunity = FactoryBot.create(:slot_recapture_opportunity, :offered)

      patch filled_slot_recapture_opportunity_path(opportunity)

      expect(response).to redirect_to(slot_recapture_opportunities_path)
    end
  end

  describe "PATCH #expired" do
    it "marks opportunity as expired" do
      opportunity = FactoryBot.create(:slot_recapture_opportunity, :open)

      patch expired_slot_recapture_opportunity_path(opportunity)

      opportunity.reload
      expect(opportunity.status).to eq("expired")
    end

    it "redirects to index after marking as expired" do
      opportunity = FactoryBot.create(:slot_recapture_opportunity, :open)

      patch expired_slot_recapture_opportunity_path(opportunity)

      expect(response).to redirect_to(slot_recapture_opportunities_path)
    end
  end
end
