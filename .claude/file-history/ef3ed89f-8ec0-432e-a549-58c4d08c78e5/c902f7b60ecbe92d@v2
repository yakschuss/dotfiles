# frozen_string_literal: true

require "rails_helper"

RSpec.describe SlotRecapture::Opportunity, type: :model do
  describe "state machine" do
    context "from pending_verification" do
      it "transitions to open" do
        opportunity = FactoryBot.create(:slot_recapture_opportunity, status: "pending_verification")

        expect(opportunity.can_transition_to?(:open)).to eq(true)
        opportunity.open!
        expect(opportunity.status).to eq("open")
      end

      it "transitions to ineligible" do
        opportunity = FactoryBot.create(:slot_recapture_opportunity, status: "pending_verification")

        opportunity.ineligible!
        expect(opportunity.status).to eq("ineligible")
      end

      it "cannot transition to filled" do
        opportunity = FactoryBot.create(:slot_recapture_opportunity, status: "pending_verification")

        expect(opportunity.can_transition_to?(:filled)).to eq(false)
      end
    end

    context "from open" do
      it "transitions to offered" do
        opportunity = FactoryBot.create(:slot_recapture_opportunity, :open)

        opportunity.offered!
        expect(opportunity.status).to eq("offered")
      end

      it "transitions to expired" do
        opportunity = FactoryBot.create(:slot_recapture_opportunity, :open)

        opportunity.expired!
        expect(opportunity.status).to eq("expired")
      end
    end

    context "from offered" do
      it "transitions to filled" do
        opportunity = FactoryBot.create(:slot_recapture_opportunity, :offered)

        opportunity.filled!
        expect(opportunity.status).to eq("filled")
      end

      it "transitions back to open" do
        opportunity = FactoryBot.create(:slot_recapture_opportunity, :offered)

        opportunity.open!
        expect(opportunity.status).to eq("open")
      end

      it "transitions to expired" do
        opportunity = FactoryBot.create(:slot_recapture_opportunity, :offered)

        opportunity.expired!
        expect(opportunity.status).to eq("expired")
      end
    end
  end

  describe ".actionable" do
    it "returns open and offered opportunities" do
      open_opp = FactoryBot.create(:slot_recapture_opportunity, :open)
      offered_opp = FactoryBot.create(:slot_recapture_opportunity, :offered)
      FactoryBot.create(:slot_recapture_opportunity, :filled)
      FactoryBot.create(:slot_recapture_opportunity, :expired)

      expect(SlotRecapture::Opportunity.actionable).to match_array([open_opp, offered_opp])
    end
  end

  describe ".pending" do
    it "returns pending_verification opportunities" do
      pending_opp = FactoryBot.create(:slot_recapture_opportunity, status: "pending_verification")
      FactoryBot.create(:slot_recapture_opportunity, :open)

      expect(SlotRecapture::Opportunity.pending).to eq([pending_opp])
    end
  end

  describe ".by_start_time" do
    it "orders by start_time ascending" do
      later = FactoryBot.create(:slot_recapture_opportunity, :open, start_time: 72.hours.from_now)
      earlier = FactoryBot.create(:slot_recapture_opportunity, :open, start_time: 24.hours.from_now)

      expect(SlotRecapture::Opportunity.by_start_time).to eq([earlier, later])
    end
  end

  describe "#hours_until_start" do
    it "calculates hours until appointment start" do
      opportunity = FactoryBot.build(:slot_recapture_opportunity, start_time: 48.hours.from_now)

      expect(opportunity.hours_until_start).to eq(48)
    end
  end

  describe "validations" do
    it "requires unique cancelled_appointment_id" do
      appointment = FactoryBot.create(:appointment, :with_care_case, :in_the_future)
      FactoryBot.create(:slot_recapture_opportunity, cancelled_appointment: appointment)

      duplicate = FactoryBot.build(:slot_recapture_opportunity, cancelled_appointment: appointment)
      expect(duplicate).not_to be_valid
      expect(duplicate.errors[:cancelled_appointment_id]).to include("has already been taken")
    end
  end

  describe "associations" do
    it "belongs to cancelled_appointment" do
      opportunity = FactoryBot.create(:slot_recapture_opportunity)
      expect(opportunity.cancelled_appointment).to be_a(Appointment)
    end

    it "belongs to staffer" do
      opportunity = FactoryBot.create(:slot_recapture_opportunity)
      expect(opportunity.staffer).to be_a(Staffer)
    end

    it "belongs to clinic" do
      opportunity = FactoryBot.create(:slot_recapture_opportunity)
      expect(opportunity.clinic).to be_a(Clinic)
    end

    it "has many outreach_attempts" do
      opportunity = FactoryBot.create(:slot_recapture_opportunity, :open)
      entry = FactoryBot.create(:wait_list_entry, :with_care_case, :active)
      outreach = FactoryBot.create(:wait_list_outreach_attempt, entry: entry, slot_recapture_opportunity: opportunity)

      expect(opportunity.outreach_attempts).to include(outreach)
    end
  end
end
