# frozen_string_literal: true

require "rails_helper"

require Rails.root.join("db", "data", "20251212095222_add_coaching_ongoing_capabilities.rb")

RSpec.describe AddCoachingOngoingCapabilities, type: :migration do
  describe "#up" do
    it "creates coaching_ongoing capabilities for staffers with coaching capability" do
      staffer = FactoryBot.create(:staffer)
      FactoryBot.create(:care_capability, :coaching, staffer: staffer, region: Region.us)

      expect { described_class.new.up }.to change { CareCapability.where(capability_id: "coaching_ongoing").count }.by(1)

      ongoing_capability = CareCapability.find_by(staffer: staffer, capability_id: "coaching_ongoing")
      expect(ongoing_capability).to be_present
      expect(ongoing_capability.region_id.to_s).to eq("us")
    end

    it "creates coaching_ongoing for each region where staffer has coaching" do
      staffer = FactoryBot.create(:staffer)
      FactoryBot.create(:care_capability, :coaching, staffer: staffer, region: Region.us)
      FactoryBot.create(:care_capability, :coaching, staffer: staffer, region: Region.california)

      expect { described_class.new.up }.to change { CareCapability.where(capability_id: "coaching_ongoing").count }.by(2)

      expect(CareCapability.exists?(staffer: staffer, capability_id: "coaching_ongoing", region_id: "us")).to be true
      expect(CareCapability.exists?(staffer: staffer, capability_id: "coaching_ongoing", region_id: "california")).to be true
    end

    it "is idempotent" do
      staffer = FactoryBot.create(:staffer)
      FactoryBot.create(:care_capability, :coaching, staffer: staffer, region: Region.us)

      described_class.new.up

      expect { described_class.new.up }.not_to change { CareCapability.where(capability_id: "coaching_ongoing").count }
    end

    it "does not create capabilities for staffers without coaching" do
      staffer = FactoryBot.create(:staffer)
      FactoryBot.create(:care_capability, :therapy, staffer: staffer, region: Region.us)

      expect { described_class.new.up }.not_to change { CareCapability.where(capability_id: "coaching_ongoing").count }
    end
  end
end
