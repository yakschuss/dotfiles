# frozen_string_literal: true

require "rails_helper"

RSpec.feature "appointment rescheduling", type: :feature, js: true, scope: :members do
  include TestDoubles::Acuity

  def setup_reschedule_data(member:, patient:, staffer:, initial_start_time:, appointment_type_id:)
    account = FactoryBot.create(:account, caregivers: [member], owner: member)
    care_case = FactoryBot.create(:care_case, caregivers: [member], patient: patient, account: account)

    appointment = FactoryBot.create(
      :appointment,
      care_case: care_case,
      staffer: staffer,
      member: member,
      start_time: initial_start_time,
      appointment_type_id: appointment_type_id
    )

    {account: account, care_case: care_case, appointment: appointment}
  end

  shared_examples "rescheduling more than 24 hours in advance" do
    scenario "able to successfully reschedule" do
      staffer = FactoryBot.create(:staffer, :sade, acuity_calendar_id: 80283)
      member = FactoryBot.create(:member, :registered, timezone: "Pacific Time (US & Canada)")
      patient = FactoryBot.create(:member, timezone: "Pacific Time (US & Canada)")
      initial_start_time = 2.days.from_now.in_time_zone(member.timezone).change({hour: 9, min: 0, sec: 0})
      rescheduled_start_time = initial_start_time + 4.hours

      data = setup_reschedule_data(
        member: member,
        patient: patient,
        staffer: staffer,
        initial_start_time: initial_start_time,
        appointment_type_id: :therapy_telehealth
      )

      expect_acuity_available_dates(dates: [initial_start_time.to_date])
      expect_acuity_availability(times: [rescheduled_start_time])
      expect_acuity_appointment_to_be_rescheduled(
        for_id: data[:appointment].acuity_appointment_id,
        start_time: rescheduled_start_time
      )

      log_in_as_member(member)

      visit members_appointments_path(data[:care_case])

      click_on("Reschedule")

      expect(page).to have_content("Reschedule your appointment", wait: 10)
      expect(page).to have_button("Book appointment", disabled: true)
      expect(page.current_path).to eq(edit_appointment_path(data[:appointment].id))

      # We can't know which timzeone the browser is running in, so we click the first button
      within("[data-test-id=appointment-slots-list]") do
        find("a", match: :first).click
      end

      expect(page).to have_button("Book appointment", disabled: false)

      click_on("Book appointment")

      expect(page).to have_content("Your appointment is rescheduled. See page below for details.")
      expect(page.current_path).to eq(members_appointments_path)
    end
  end

  shared_examples "canceling and rescheduling within 24 hours" do
    it "books a new session with the canceled appointment context" do
      staffer = FactoryBot.create(:staffer, :sade, acuity_calendar_id: 80283)
      member = FactoryBot.create(:member, :registered, timezone: "Pacific Time (US & Canada)")
      patient = FactoryBot.create(:member, timezone: "Pacific Time (US & Canada)")
      initial_start_time = (Time.now.in_time_zone(member.timezone) + 4.hours).change({min: 0, sec: 0})
      rescheduled_start_time = initial_start_time + 24.hours

      data = setup_reschedule_data(
        member: member,
        patient: patient,
        staffer: staffer,
        initial_start_time: initial_start_time,
        appointment_type_id: :therapy_initial_session
      )

      expect_acuity_available_dates(dates: [initial_start_time.to_date + 1.day])
      expect_acuity_availability(times: [rescheduled_start_time])
      expect_acuity_appointment_to_be_created(
        calendar_id: staffer.acuity_calendar_id,
        datetime: rescheduled_start_time,
        with_id: 1234
      )

      log_in_as_member(member)

      visit members_appointments_path(data[:care_case])

      click_on("Cancel session")

      expect(page).to have_content("Are you sure", wait: 10)
      click_on("Yes, continue to cancel")

      expect(page).to have_content("What is the reason", wait: 10)
      choose("I have a one-time scheduling conflict")

      within("#appointment-cancelation-form") do
        click_on("Cancel session")
      end

      expect(page).to have_content("has been canceled")

      click_on("Reschedule session")

      expect(page).to have_current_path(edit_appointment_path(data[:appointment].id))
      expect(page).to have_button("Book appointment", disabled: true)

      # We can't know which timzeone the browser is running in, so we click the first button
      within("[data-test-id=appointment-slots-list]") do
        find("a", match: :first).click
      end

      expect(page).to have_button("Book appointment", disabled: false)

      click_on("Book appointment")

      expect(page).to have_content("Your appointment is rescheduled. See page below for details.")
      expect(page.current_path).to eq(members_appointments_path)
    end
  end

  context "with new calendaring API (feature flag enabled)" do
    before do
      Flipper.enable(:change_calendaring_times_api)
    end

    context "when rescheduling more than 24 hours in advance" do
      include_examples "rescheduling more than 24 hours in advance"
    end

    context "when canceling and rescheduling within 24 hours" do
      include_examples "canceling and rescheduling within 24 hours"
    end
  end

  context "with legacy calendaring API (feature flag disabled)" do
    before do
      Flipper.disable(:change_calendaring_times_api)
    end

    context "when rescheduling more than 24 hours in advance" do
      include_examples "rescheduling more than 24 hours in advance"
    end

    context "when canceling and rescheduling within 24 hours" do
      include_examples "canceling and rescheduling within 24 hours"
    end
  end
end
