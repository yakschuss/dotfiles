# Create test slot recapture opportunities
# Run with: bundle exec rails runner tmp/create_test_opportunities.rb

puts "Creating test slot recapture opportunities..."

# Find appointments 48-72 hours out
appointments = Appointment.scheduled
  .where(start_time: 48.hours.from_now..72.hours.from_now)
  .where.not(id: SlotRecapture::Opportunity.select(:cancelled_appointment_id))
  .includes(:staffer, :clinic, :care_case)
  .limit(5)

if appointments.empty?
  puts "No suitable appointments found in 48-72h window"
  puts "Looking for any scheduled appointments..."
  appointments = Appointment.scheduled
    .where("start_time > ?", 25.hours.from_now)
    .where.not(id: SlotRecapture::Opportunity.select(:cancelled_appointment_id))
    .includes(:staffer, :clinic, :care_case)
    .limit(5)
end

if appointments.empty?
  puts "ERROR: No suitable appointments found"
  exit 1
end

puts "Found #{appointments.count} appointments to convert to opportunities"

created = 0
appointments.each do |appt|
  next unless appt.clinic.present?
  next unless appt.care_case&.region_id.present?

  opp = SlotRecapture::Opportunity.new(
    cancelled_appointment: appt,
    staffer: appt.staffer,
    clinic: appt.clinic,
    appointment_type_id: appt.appointment_type_id,
    root_appointment_type_id: appt.root_appointment_type_id,
    region_id: appt.care_case.region_id,
    start_time: appt.start_time,
    lead_time_hours: ((appt.start_time - Time.current) / 1.hour).round,
    status: "open"
  )

  if opp.save
    created += 1
    puts "  Created: #{opp.staffer.full_name} @ #{opp.start_time.strftime('%b %d %l:%M %p')}"
  else
    puts "  Skipped #{appt.id}: #{opp.errors.full_messages.join(', ')}"
  end
end

puts "\nCreated #{created} opportunities"
puts "Total actionable: #{SlotRecapture::Opportunity.actionable.count}"
