# frozen_string_literal: true

require "rails_helper"

RSpec.describe Chat::AccessibleStafferChannel do
  let!(:randy) { FactoryBot.create(:member, :with_sendbird_user, first_name: "Randy", last_name: "Marsh") }
  let!(:stan) { FactoryBot.create(:member, :with_sendbird_user, first_name: "Stan", last_name: "Marsh") }
  let!(:account) { FactoryBot.create(:account, caregivers: [randy], children: [stan]) }

  let!(:liane) { FactoryBot.create(:seed_member, :with_sendbird_user, :liane_cartman) }
  let!(:eric) { FactoryBot.create(:seed_member, :with_sendbird_user, :eric_cartman) }
  let!(:other_account) { FactoryBot.create(:account, caregivers: [liane], children: [eric]) }

  let!(:spectator_sendbird_user) { Chat::SpectatorParticipant.sendbird_user_with_fewest_memberships }
  let!(:member_support_sendbird_user) { Chat::MemberSupportParticipant.sendbird_user_with_fewest_memberships }

  let!(:member_support) { FactoryBot.create(:staffer, :cindy, can_chat_as_member_support: true) }
  let!(:coach) { FactoryBot.create(:staffer, :neil, can_chat_as_member_support: false, can_spectate_chats: true) }
  let!(:clinician) { FactoryBot.create(:staffer, :marvin, can_chat_as_member_support: false, can_spectate_chats: true) }

  describe ".for_all_members_scoped_to_staffer" do
    it "returns a collection of SendbirdChatChannels" do
      stan_coach_channel = FactoryBot.create(
        :sendbird_chat_channel, :coach,
        account: account,
        sendbird_users: [stan.sendbird_user, Chat::StafferParticipant.new(coach).sendbird_user_with_fewest_memberships, spectator_sendbird_user]
      )
      # deactivated
      _stan_ms_channel = FactoryBot.create(
        :sendbird_chat_channel, :member_support,
        account: account,
        sendbird_users: [stan.sendbird_user, member_support_sendbird_user, spectator_sendbird_user],
        deactivated_at: 1.week.ago
      )

      accessible_coach_channels = described_class.for_all_members_scoped_to_staffer(account: account, staffer: coach)
      expect(accessible_coach_channels.count).to eq(1)
      expect(accessible_coach_channels.map(&:sendbird_chat_channel)).to match_array([
        stan_coach_channel
      ])
    end
  end

  describe ".for" do
    it "returns an ordered collection of SendbirdChatChannels" do
      coach_sendbird_user = Chat::StafferParticipant.new(coach).sendbird_user_with_fewest_memberships
      care_guide_sendbird_user = Chat::StafferParticipant.new(FactoryBot.create(:staffer, :care_guide)).sendbird_user_with_fewest_memberships

      stan_coach_channel = FactoryBot.create(
        :sendbird_chat_channel, :coach,
        account: account,
        sendbird_users: [stan.sendbird_user, coach_sendbird_user, spectator_sendbird_user]
      )
      stan_ms_channel = FactoryBot.create(
        :sendbird_chat_channel, :member_support,
        account: account,
        sendbird_users: [stan.sendbird_user, member_support_sendbird_user, spectator_sendbird_user]
      )
      stan_careguide_channel = FactoryBot.create(
        :sendbird_chat_channel, :care_guide,
        account: account,
        sendbird_users: [stan.sendbird_user, care_guide_sendbird_user, spectator_sendbird_user]
      )

      # Coach can access their own chat and spectate MS and care guide chats as well as their own chat
      accessible_coach_channels = described_class.for(account: account, staffer: coach, member: stan)
      expect(accessible_coach_channels.count).to eq(4)
      expect(accessible_coach_channels.map(&:sendbird_chat_channel)).to eq([
        stan_coach_channel,
        stan_careguide_channel,
        stan_coach_channel,
        stan_ms_channel
      ])
      expect(accessible_coach_channels.map(&:sendbird_user)).to eq([
        coach_sendbird_user,
        spectator_sendbird_user,
        spectator_sendbird_user,
        spectator_sendbird_user
      ])

      # MS has access to the MS channel only based on settings
      accessible_ms_channels = described_class.for(account: account, staffer: member_support, member: stan)
      expect(accessible_ms_channels.count).to eq(1)
      expect(accessible_ms_channels.map(&:sendbird_chat_channel)).to match_array([stan_ms_channel])

      # The clinician can spectate the chats
      accessible_clinician_channels = described_class.for(account: account, staffer: clinician, member: stan)
      expect(accessible_clinician_channels.count).to eq(3)
      expect(accessible_clinician_channels.map(&:sendbird_chat_channel)).to match_array([
        stan_ms_channel, stan_coach_channel, stan_careguide_channel
      ])
    end
  end

  describe ".for with prefer_unmuted" do
    it "returns only the unmuted channel if both muted and unmuted exist for the same chat" do
      stan = FactoryBot.create(:member, :with_sendbird_user, first_name: "Stan", last_name: "Marsh")
      account = FactoryBot.create(:account, children: [stan])
      coach = FactoryBot.create(:staffer, :neil, can_chat_as_member_support: false, can_spectate_chats: true)
      coach_sendbird_user = Chat::StafferParticipant.new(coach).sendbird_user_with_fewest_memberships
      spectator_sendbird_user = Chat::SpectatorParticipant.sendbird_user_with_fewest_memberships
      FactoryBot.create(
        :sendbird_chat_channel, :coach,
        account: account,
        sendbird_users: [stan.sendbird_user, coach_sendbird_user, spectator_sendbird_user]
      )
      result = described_class.for(account: account, staffer: coach, member: stan, prefer_unmuted: true)
      expect(result.map(&:sendbird_user)).to include(coach_sendbird_user)
      expect(result.map(&:sendbird_user)).not_to include(spectator_sendbird_user)
    end

    it "returns the muted channel if it is the only one present for the chat" do
      stan = FactoryBot.create(:member, :with_sendbird_user, first_name: "Stan", last_name: "Marsh")
      account = FactoryBot.create(:account, children: [stan])
      coach = FactoryBot.create(:staffer, :neil, can_chat_as_member_support: false, can_spectate_chats: true)
      spectator_sendbird_user = Chat::SpectatorParticipant.sendbird_user_with_fewest_memberships
      FactoryBot.create(
        :sendbird_chat_channel, :coach,
        account: account,
        sendbird_users: [stan.sendbird_user, spectator_sendbird_user]
      )
      result = described_class.for(account: account, staffer: coach, member: stan, prefer_unmuted: true)
      expect(result.map(&:sendbird_user)).to include(spectator_sendbird_user)
      coach_sendbird_user = Chat::StafferParticipant.new(coach).sendbird_user_with_fewest_memberships
      expect(result.map(&:sendbird_user)).not_to include(coach_sendbird_user)
    end
  end

  describe ".from_sendbird_chat_channels_and_staffer" do
    it "properly returns only the correct Sendbird User/Chat Channel combinations when the staffer has multiple sendbird users" do
      staffer = FactoryBot.create(:staffer)
      sendbird_users = FactoryBot.create_list(:sendbird_user, 3, :staffer, participant: staffer)

      sendbird_chat_channels = sendbird_users.map do |staffer_sendbird_user|
        FactoryBot.create(
          :sendbird_chat_channel, :coach,
          account: account,
          sendbird_users: [staffer_sendbird_user]
        )
      end

      accessible_channels = described_class.from_sendbird_chat_channels_and_staffer(sendbird_chat_channels, staffer)

      expect(accessible_channels.size).to eq(3)
    end
  end

  describe "#unread_messages?" do
    it "returns true if there are unread messages for the sendbird user" do
      channel = FactoryBot.create(
        :sendbird_chat_channel,
        account: account,
        sendbird_users: [stan.sendbird_user, Chat::StafferParticipant.new(coach).sendbird_user_with_fewest_memberships, Chat::SpectatorParticipant.sendbird_user_with_fewest_memberships]
      )

      accessible_channel = described_class.new(sendbird_chat_channel: channel, sendbird_user: Chat::StafferParticipant.new(coach).sendbird_user_with_fewest_memberships)
      expect(accessible_channel.unread_messages?).to be(false)

      channel.memberships.where(sendbird_user: Chat::StafferParticipant.new(coach).sendbird_user_with_fewest_memberships).update_all(unread_message_count: 5)
      accessible_channel = described_class.new(sendbird_chat_channel: channel, sendbird_user: Chat::StafferParticipant.new(coach).sendbird_user_with_fewest_memberships)
      expect(accessible_channel.unread_messages?).to be(true)
    end
  end

  describe "#short_name" do
    let!(:spectator_sendbird_user) { Chat::SpectatorParticipant.sendbird_user_with_fewest_memberships }

    it "returns a context sensitive name" do
      channel = FactoryBot.create(
        :sendbird_chat_channel,
        account: account,
        sendbird_users: [stan.sendbird_user, Chat::StafferParticipant.new(coach).sendbird_user_with_fewest_memberships, spectator_sendbird_user]
      )

      expect(described_class.new(sendbird_chat_channel: channel, sendbird_user: Chat::StafferParticipant.new(coach).sendbird_user_with_fewest_memberships).short_name)
        .to eq("Coach chat")
      expect(described_class.new(sendbird_chat_channel: channel, sendbird_user: spectator_sendbird_user).short_name)
        .to eq("Coach chat (view only)")
    end
  end

  describe "#staffer_responded_to_last_message?" do
    it "is true if the staffer sent a more recent message" do
      coach = FactoryBot.create(:staffer, :coach)
      caregiver = FactoryBot.create(:member, :with_personal_information, :with_sendbird_user, first_name: "Donald")
      account = FactoryBot.create(:account, owner: caregiver, caregivers: [caregiver])
      channel = FactoryBot.create(:sendbird_chat_channel, account: account)
      coach_sendbird_user = Chat::StafferParticipant.new(coach).sendbird_user_with_fewest_memberships
      FactoryBot.create(:sendbird_chat_channel_membership, sendbird_chat_channel: channel, sendbird_user: caregiver.sendbird_user, last_message_sent_at: 5.hours.ago)
      FactoryBot.create(:sendbird_chat_channel_membership, sendbird_chat_channel: channel, sendbird_user: coach_sendbird_user, last_message_sent_at: 1.hour.ago)
      FactoryBot.create(:care_case, account: account, caregivers: [caregiver])

      instance = described_class.new(sendbird_chat_channel: channel, sendbird_user: coach_sendbird_user)

      expect(instance.staffer_responded_to_last_message?).to be_truthy
    end

    it "is false if the member has a more recent message" do
      coach = FactoryBot.create(:staffer, :coach)
      caregiver = FactoryBot.create(:member, :with_personal_information, :with_sendbird_user, first_name: "Donald")
      account = FactoryBot.create(:account, owner: caregiver, caregivers: [caregiver])
      channel = FactoryBot.create(:sendbird_chat_channel, account: account)
      coach_sendbird_user = Chat::StafferParticipant.new(coach).sendbird_user_with_fewest_memberships
      FactoryBot.create(:sendbird_chat_channel_membership, sendbird_chat_channel: channel, sendbird_user: caregiver.sendbird_user, last_message_sent_at: 1.hour.ago)
      FactoryBot.create(:sendbird_chat_channel_membership, sendbird_chat_channel: channel, sendbird_user: coach_sendbird_user, last_message_sent_at: 5.hours.ago)

      instance = described_class.new(sendbird_chat_channel: channel, sendbird_user: coach_sendbird_user)

      expect(instance.staffer_responded_to_last_message?).to be_falsey
    end
  end

  describe "#sort" do
    it "sorts channels by the membership's last_message_sent_at from oldest to newest" do
      coach = FactoryBot.create(:staffer, :coach)
      caregiver = FactoryBot.create(:member, :with_personal_information, :with_sendbird_user, first_name: "Donald")
      account = FactoryBot.create(:account, owner: caregiver, caregivers: [caregiver])
      coach_sendbird_user = Chat::StafferParticipant.new(coach).sendbird_user_with_fewest_memberships

      channel_with_no_sent_message = FactoryBot.create(:sendbird_chat_channel, account: account)
      FactoryBot.create(:sendbird_chat_channel_membership, sendbird_chat_channel: channel_with_no_sent_message, sendbird_user: caregiver.sendbird_user, last_message_sent_at: nil)
      FactoryBot.create(:sendbird_chat_channel_membership, sendbird_chat_channel: channel_with_no_sent_message, sendbird_user: coach_sendbird_user, last_message_sent_at: nil)

      channel_with_oldest_sent_message = FactoryBot.create(:sendbird_chat_channel, account: account)
      FactoryBot.create(:sendbird_chat_channel_membership, sendbird_chat_channel: channel_with_oldest_sent_message, sendbird_user: caregiver.sendbird_user, last_message_sent_at: 4.hour.ago)
      FactoryBot.create(:sendbird_chat_channel_membership, sendbird_chat_channel: channel_with_oldest_sent_message, sendbird_user: coach_sendbird_user, last_message_sent_at: 5.hours.ago)

      channel_with_most_recent_sent_message = FactoryBot.create(:sendbird_chat_channel, account: account)
      FactoryBot.create(:sendbird_chat_channel_membership, sendbird_chat_channel: channel_with_most_recent_sent_message, sendbird_user: caregiver.sendbird_user, last_message_sent_at: 1.hour.ago)
      FactoryBot.create(:sendbird_chat_channel_membership, sendbird_chat_channel: channel_with_most_recent_sent_message, sendbird_user: coach_sendbird_user, last_message_sent_at: 2.hours.ago)

      accessible_staffer_channels = [
        described_class.new(sendbird_chat_channel: channel_with_most_recent_sent_message, sendbird_user: coach_sendbird_user),
        described_class.new(sendbird_chat_channel: channel_with_oldest_sent_message, sendbird_user: coach_sendbird_user),
        described_class.new(sendbird_chat_channel: channel_with_no_sent_message, sendbird_user: coach_sendbird_user)
      ]

      expect(accessible_staffer_channels.sort.map(&:sendbird_chat_channel).map(&:id)).to eq([
        channel_with_most_recent_sent_message.id,
        channel_with_oldest_sent_message.id,
        channel_with_no_sent_message.id
      ])
    end

    it "sorts channels by the membership's unread status first, then last_message_sent_at from oldest to newest" do
      coach = FactoryBot.create(:staffer, :coach)
      caregiver = FactoryBot.create(:member, :with_personal_information, :with_sendbird_user, first_name: "Donald")
      account = FactoryBot.create(:account, owner: caregiver, caregivers: [caregiver])
      coach_sendbird_user = Chat::StafferParticipant.new(coach).sendbird_user_with_fewest_memberships

      channel_with_oldest_read_message = FactoryBot.create(:sendbird_chat_channel, account: account)
      FactoryBot.create(:sendbird_chat_channel_membership, sendbird_chat_channel: channel_with_oldest_read_message, sendbird_user: caregiver.sendbird_user, last_message_sent_at: 4.hour.ago)
      FactoryBot.create(:sendbird_chat_channel_membership, sendbird_chat_channel: channel_with_oldest_read_message, sendbird_user: coach_sendbird_user, last_message_sent_at: 5.hours.ago)

      channel_with_most_recent_but_unread_message = FactoryBot.create(:sendbird_chat_channel, account: account)
      FactoryBot.create(:sendbird_chat_channel_membership, sendbird_chat_channel: channel_with_most_recent_but_unread_message, sendbird_user: caregiver.sendbird_user, last_message_sent_at: 1.hour.ago)
      FactoryBot.create(:sendbird_chat_channel_membership, :with_unread_messages, sendbird_chat_channel: channel_with_most_recent_but_unread_message, sendbird_user: coach_sendbird_user, last_message_sent_at: 2.hours.ago)

      accessible_staffer_channels = [
        described_class.new(sendbird_chat_channel: channel_with_oldest_read_message, sendbird_user: coach_sendbird_user),
        described_class.new(sendbird_chat_channel: channel_with_most_recent_but_unread_message, sendbird_user: coach_sendbird_user)
      ]

      expect(accessible_staffer_channels.sort.map(&:sendbird_chat_channel)).to eq([
        channel_with_most_recent_but_unread_message,
        channel_with_oldest_read_message
      ])
    end
  end
end
