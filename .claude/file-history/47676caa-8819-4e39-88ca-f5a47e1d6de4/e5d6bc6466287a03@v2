# frozen_string_literal: true

require "rails_helper"

RSpec.describe SlotRecapture::ExpireOpportunitiesJob, type: :job do
  before do
    Flipper.enable(:slot_recapture_enabled)
  end

  after do
    Flipper.disable(:slot_recapture_enabled)
  end

  describe "#perform" do
    it "expires open opportunities that have passed their start time" do
      opportunity = FactoryBot.create(:slot_recapture_opportunity,
        :open,
        start_time: 1.hour.ago)

      described_class.new.perform

      opportunity.reload
      expect(opportunity.status).to eq("expired")
    end

    it "expires offered opportunities that have passed their start time" do
      opportunity = FactoryBot.create(:slot_recapture_opportunity,
        :offered,
        start_time: 1.hour.ago)

      described_class.new.perform

      opportunity.reload
      expect(opportunity.status).to eq("expired")
    end

    it "does not expire opportunities with future start times" do
      opportunity = FactoryBot.create(:slot_recapture_opportunity,
        :open,
        start_time: 1.hour.from_now)

      described_class.new.perform

      opportunity.reload
      expect(opportunity.status).to eq("open")
    end

    it "does not modify already expired opportunities" do
      opportunity = FactoryBot.create(:slot_recapture_opportunity,
        :expired,
        start_time: 1.hour.ago)

      expect {
        described_class.new.perform
      }.not_to change { opportunity.reload.updated_at }
    end

    it "does not modify filled opportunities" do
      opportunity = FactoryBot.create(:slot_recapture_opportunity,
        :filled,
        start_time: 1.hour.ago)

      expect {
        described_class.new.perform
      }.not_to change { opportunity.reload.updated_at }
    end

    it "does nothing when feature flag is disabled" do
      Flipper.disable(:slot_recapture_enabled)

      opportunity = FactoryBot.create(:slot_recapture_opportunity,
        :open,
        start_time: 1.hour.ago)

      described_class.new.perform

      opportunity.reload
      expect(opportunity.status).to eq("open")
    end

    it "expires multiple opportunities in a single run" do
      opportunity1 = FactoryBot.create(:slot_recapture_opportunity,
        :open,
        start_time: 2.hours.ago)
      opportunity2 = FactoryBot.create(:slot_recapture_opportunity,
        :offered,
        start_time: 1.hour.ago)

      described_class.new.perform

      expect(opportunity1.reload.status).to eq("expired")
      expect(opportunity2.reload.status).to eq("expired")
    end
  end
end
