# frozen_string_literal: true

module SlotRecapture
  class OpportunitiesController < BaseController
    layout "application_strapless"
    navbar_collapsed

    before_action :ensure_feature_enabled
    before_action :set_opportunity, only: %i[show filled expired]

    def index
      authorize Opportunity, policy_class: OpportunityPolicy
      @opportunities = Opportunity.actionable.by_start_time.includes(:staffer, :clinic, :cancelled_appointment)
      @configuration = Configuration.current
    end

    def update_configuration
      authorize Opportunity, policy_class: OpportunityPolicy
      @configuration = Configuration.new(
        data: ConfigurationData.new(configuration_params),
        created_by: current_staffer
      )

      if @configuration.save
        flash[:success] = "Configuration updated"
      else
        flash[:error] = "Failed to update configuration"
      end
      redirect_to slot_recapture_opportunities_path
    end

    def show
      @matches = matcher.matches_for(@opportunity)
    end

    def filled
      @opportunity.filled!
      flash[:success] = "Opportunity marked as filled"
      redirect_to slot_recapture_opportunities_path
    end

    def expired
      @opportunity.expired!
      flash[:success] = "Opportunity marked as expired"
      redirect_to slot_recapture_opportunities_path
    end

    private

    def matcher
      @matcher ||= Matcher.new
    end

    def ensure_feature_enabled
      raise ActiveRecord::RecordNotFound unless Flipper.enabled?(:slot_recapture_enabled)
    end

    def set_opportunity
      @opportunity = Opportunity.find(params[:id])
      authorize @opportunity, policy_class: OpportunityPolicy
    end

    def configuration_params
      params.require(:configuration).permit(
        :lead_time_hours_minimum,
        :matches_per_opportunity,
        :auto_detect_filled,
        :weight_same_provider,
        :weight_clinic_match,
        :weight_exact_type,
        :weight_priority,
        :weight_wait_time
      )
    end
  end
end
