# frozen_string_literal: true

require "rails_helper"

RSpec.describe Members::CareCases::AppointmentSchedulingRequestsController, scope: :members do
  include TestDoubles::Acuity

  def do_setup(*appointment_scheduling_request_traits)
    staffer = FactoryBot.create(:staffer, :sade)
    member = FactoryBot.create(:member, :with_personal_information, :with_login, timezone: "Pacific Time (US & Canada)")
    care_case = FactoryBot.create(:care_case, region: Region.california, patient: member)
    log_in_as_member(member)

    FactoryBot.create(:appointment_scheduling_request, *appointment_scheduling_request_traits, staffer: staffer, member: member, care_case: care_case)
  end

  describe "GET /care_cases/:care_case_id/appointment_scheduling_requests/:id" do
    context "with new calendaring API (feature flag enabled)" do
      before do
        Flipper.enable(:change_calendaring_times_api)
      end

      context "success" do
        it "shows slots" do
          appointment_scheduling_request = do_setup

          start_time = Time.zone.now.tomorrow.to_date
          expect_acuity_available_dates(dates: [start_time])

          appointment_time = Time.zone.now.tomorrow.change({hour: 9, min: 0o0, sec: 0})
          expect_calendaring_api_availability(times: [appointment_time], staffer: appointment_scheduling_request.staffer)

          request_reporter = double(track!: true)
          expect(Calendaring::AppointmentAvailabilityRequestReporter).to receive(:new).with(
            request_context: Calendaring::AvailabilityRequestContext.appointment_scheduling_request,
            care_case: anything,
            member: anything,
            staffers: anything,
            root_appointment_type: anything,
            filters: hash_including(:region, :appointment_type, :payer)
          ) { request_reporter }

          get members_care_case_appointment_scheduling_request_url(appointment_scheduling_request.care_case, appointment_scheduling_request)
          expect(response.body).to include(I18n.l(start_time, format: :weekday_and_short_date))
          expect(response.body).to include("Schedule your appointment")
          expect(response.body).to include("9:00am")
          expect(request_reporter).to have_received(:track!)
        end
      end

      context "failure" do
        it "shows error page" do
          appointment_scheduling_request = do_setup
          expect_acuity_availability_to_raise_exception

          get members_care_case_appointment_scheduling_request_url(appointment_scheduling_request.care_case, appointment_scheduling_request)
          expect(response.body).to include("We were unable to find availability for your appointment.")
        end
      end

      context "when request completed" do
        it "redirects to connect dashboard page" do
          appointment_scheduling_request = do_setup(:completed)

          get members_care_case_appointment_scheduling_request_url(appointment_scheduling_request.care_case, appointment_scheduling_request)
          expect(response).to redirect_to(members_account_family_path(appointment_scheduling_request.care_case.account))
        end
      end
    end

    context "with legacy calendaring API (feature flag disabled)" do
      before do
        Flipper.disable(:change_calendaring_times_api)
      end

      context "success" do
        it "shows slots" do
          appointment_scheduling_request = do_setup

          start_time = Time.zone.now.tomorrow.to_date
          expect_acuity_available_dates(dates: [start_time])

          appointment_time = Time.zone.now.tomorrow.change({hour: 9, min: 0o0, sec: 0})
          expect_acuity_availability(times: [appointment_time])

          request_reporter = double(track!: true)
          expect(Calendaring::AppointmentAvailabilityRequestReporter).to receive(:from_availability_context).with(
            an_instance_of(Calendaring::AvailabilityContext)
          ) { request_reporter }

          get members_care_case_appointment_scheduling_request_url(appointment_scheduling_request.care_case, appointment_scheduling_request)
          expect(response.body).to include(I18n.l(start_time, format: :weekday_and_short_date))
          expect(response.body).to include("Schedule your appointment")
          expect(response.body).to include("9:00am")
          expect(request_reporter).to have_received(:track!)
        end
      end

      context "failure" do
        it "shows error page" do
          appointment_scheduling_request = do_setup
          expect_acuity_availability_to_raise_exception

          get members_care_case_appointment_scheduling_request_url(appointment_scheduling_request.care_case, appointment_scheduling_request)
          expect(response.body).to include("We were unable to find availability for your appointment.")
        end
      end

      context "when request completed" do
        it "redirects to connect dashboard page" do
          appointment_scheduling_request = do_setup(:completed)

          get members_care_case_appointment_scheduling_request_url(appointment_scheduling_request.care_case, appointment_scheduling_request)
          expect(response).to redirect_to(members_account_family_path(appointment_scheduling_request.care_case.account))
        end
      end
    end
  end
end
