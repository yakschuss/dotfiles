# frozen_string_literal: true

# == Schema Information
#
# Table name: staffers
#
#  id                                  :uuid             not null, primary key
#  can_chat_as_member_support          :boolean          default(FALSE)
#  can_spectate_chats                  :boolean          default(FALSE)
#  deactivated_at                      :datetime
#  email                               :string
#  first_name                          :string
#  last_logged_in_at                   :datetime
#  last_name                           :string
#  login_disabled_at                   :datetime
#  national_provider_identifier        :string
#  patient_age_requirements            :string           default(["\"all\""]), not null, is an Array
#  personal_email                      :string
#  timezone                            :string           not null
#  trainee                             :boolean          default(FALSE)
#  created_at                          :datetime         not null
#  updated_at                          :datetime         not null
#  acuity_calendar_id                  :integer
#  clinic_id                           :uuid
#  healthie_organization_membership_id :string
#  healthie_user_id                    :string
#  out_of_office_substitute_id         :uuid
#  region_id                           :string
#  sendbird_user_id                    :uuid
#  welkin_calendar_id                  :string
#  welkin_v8_user_id                   :string
#  welkin_worker_id                    :string
#
# Indexes
#
#  index_staffers_on_clinic_id                            (clinic_id)
#  index_staffers_on_deactivated_at                       (deactivated_at)
#  index_staffers_on_healthie_organization_membership_id  (healthie_organization_membership_id) UNIQUE
#  index_staffers_on_healthie_user_id                     (healthie_user_id) UNIQUE
#  index_staffers_on_national_provider_identifier         (national_provider_identifier) UNIQUE
#  index_staffers_on_out_of_office_substitute_id          (out_of_office_substitute_id)
#  index_staffers_on_sendbird_user_id                     (sendbird_user_id)
#
# Foreign Keys
#
#  fk_rails_...  (sendbird_user_id => sendbird_users.id)
#
FactoryBot.define do
  factory :staffer do
    first_name { without_apostrophes { Faker::Name.first_name } }
    last_name { without_apostrophes { Faker::Name.last_name } }
    timezone { "Pacific Time (US & Canada)" }
    sequence(:email) { |i| Faker::Internet.email(name: "staffer-#{i}") }
    acuity_calendar_id { rand(100000) }
    welkin_v8_user_id { SecureRandom.uuid }
    can_spectate_chats { false }
    can_chat_as_member_support { false }
    sequence(:healthie_user_id)
    sequence(:healthie_organization_membership_id)
    transient do
      region { Region.california }
      patient_age_requirements { ["all"] }
    end

    region_id { region&.id }

    trait :with_id do
      id { SecureRandom.uuid }
    end

    trait :with_bio do
      transient do
        bio_credentials { "MS, BCBA" }
        bio_photo_url { "//images.ctfassets.net/50cyioy7wubb/6L09MiXIG2Xk9Hyrqv2O8U/8908e20bc5ae54c0c81a6c1619d6a71b/coach-neil.png" }
        bio_rendered_body { "Neil is a Board Certified Behavior Analyst (BCBA) and a behavioral health coach at Brightline.\nNeil lives in Santa Monica, California, and enjoys drumming and singing with friends." }
        bio_excerpt { bio_rendered_body.truncate(50) }
        bio_intro_vimeo_url { nil }
        bio_focus_areas { [] }
      end

      after(:build) do |staffer, evaluator|
        staffer.define_singleton_method(:bio) do
          Staffer::Bio.new(
            id: staffer.email.split("@").first,
            role: staffer.prioritized_capability_group,
            email: staffer.email,
            full_name: staffer.full_name,
            focus_areas: evaluator.bio_focus_areas,
            credentials: evaluator.bio_credentials,
            photo_url: evaluator.bio_photo_url,
            excerpt: evaluator.bio_excerpt,
            rendered_body: evaluator.bio_rendered_body,
            intro_vimeo_url: evaluator.bio_intro_vimeo_url
          )
        end
      end
    end

    # TODO: No external IDs should be the default
    trait :without_external_ids do
      acuity_calendar_id { nil }
      welkin_v8_user_id { nil }
      healthie_user_id { nil }
      healthie_organization_membership_id { nil }
    end

    trait :with_acuity_calendar do
      acuity_calendar_id { rand(100000) }
    end

    trait :with_clinic do
      clinic { FactoryBot.create(:clinic) }
    end

    trait :care_ops do
      can_spectate_chats { false }
      can_chat_as_member_support { false }

      after :create do |staffer|
        FactoryBot.create(:care_capability, :care_ops, staffer: staffer, region: Region.us)
      end
    end

    trait :care_guide do
      after :create do |staffer|
        FactoryBot.create(:care_capability, :care_guide, staffer: staffer, region: Region.us)
      end
    end

    trait :care_guide_chat_only do
      after :create do |staffer|
        FactoryBot.create(:care_capability, :care_guide, staffer: staffer, region: Region.us)
      end
    end

    trait :welcome_specialist do
      can_spectate_chats { false }
      can_chat_as_member_support { false }

      transient do
        care_navigation_regions { [Region.us] }
      end

      after :create do |staffer, evaluator|
        evaluator.care_navigation_regions.each do |region|
          FactoryBot.create(:care_capability, :care_navigator, staffer: staffer, region: region)
        end
      end
    end

    # TODO: Get rid of me?
    trait :member_support do
      can_spectate_chats { false }
      can_chat_as_member_support { true }

      transient do
        member_support_regions { [Region.us] }
      end

      after :create do |staffer, evaluator|
        evaluator.member_support_regions.each do |region|
          FactoryBot.create(:care_capability, :care_navigator, staffer: staffer, region: region)
          FactoryBot.create(:care_capability, :member_support_specialist, staffer: staffer, region: region)
        end
      end
    end

    trait :member_support_specialist do
      can_spectate_chats { false }
      can_chat_as_member_support { true }

      transient do
        member_support_regions { [Region.us] }
      end

      after :create do |staffer, evaluator|
        evaluator.member_support_regions.each do |region|
          FactoryBot.create(:care_capability, :member_support_specialist, staffer: staffer, region: region)
        end
      end
    end

    trait :coach do
      can_spectate_chats { true }
      can_chat_as_member_support { false }

      transient do
        coaching_regions { [Region.us] }
        available_for_intakes { true }
        competency_levels { [] } # [ {competency: Competency.sexual_identity, level: :awareness}, ... ]
        accepting_new_connect_accounts { true }
      end

      after :create do |coach, evaluator|
        evaluator.coaching_regions.each do |region|
          FactoryBot.create(:care_capability, :coaching, staffer: coach, region: region)
          FactoryBot.create(:care_capability, :coaching_ongoing, staffer: coach, region: region)
          FactoryBot.create(:care_capability, :coaching_intake, staffer: coach, region: region) if evaluator.available_for_intakes
          FactoryBot.create(:care_capability, :new_connect_account_coaching, staffer: coach, region: region) if evaluator.accepting_new_connect_accounts
        end
        evaluator.competency_levels.each do |competency_level|
          FactoryBot.create(:care_competency, staffer: coach, competency: competency_level[:competency], level: competency_level[:level])
        end
      end
    end

    trait :therapist do
      can_spectate_chats { true }
      can_chat_as_member_support { false }
      with_national_provider_identifier

      transient do
        therapy_regions { [Region.us] }
        available_for_intakes { true }
      end

      after :create do |therapist, evaluator|
        # Always create therapy capability with region US for therapists
        FactoryBot.create(:care_capability, :therapy, staffer: therapist, region: Region.us)

        evaluator.therapy_regions.each do |region|
          FactoryBot.create(:care_capability, :therapy_ongoing, staffer: therapist, region: region)
          FactoryBot.create(:care_capability, :therapy_intake, staffer: therapist, region: region) if evaluator.available_for_intakes
        end
      end
    end

    trait :manager do
      can_spectate_chats { true }
      can_chat_as_member_support { false }

      after :create do |manager|
        FactoryBot.create(:care_capability, :manager, staffer: manager, region: Region.us)
      end
    end

    trait :contract_therapist do
      can_spectate_chats { true }
      can_chat_as_member_support { false }
      with_national_provider_identifier

      transient do
        therapy_regions { [Region.us] }
        available_for_intakes { true }
      end

      after :create do |therapist, evaluator|
        # Always create therapy capability with region US for therapists
        FactoryBot.create(:care_capability, :therapy, staffer: therapist, region: Region.us)

        evaluator.therapy_regions.each do |region|
          FactoryBot.create(:care_capability, :therapy_ongoing, staffer: therapist, region: region)
          FactoryBot.create(:care_capability, :contract_therapy, staffer: therapist, region: region)
          FactoryBot.create(:care_capability, :therapy_intake, staffer: therapist, region: region) if evaluator.available_for_intakes
        end
      end
    end

    trait :prescriber do
      can_spectate_chats { true }
      can_chat_as_member_support { false }
      with_national_provider_identifier

      transient do
        medication_management_regions { [Region.us] }
      end

      after :create do |prescriber, evaluator|
        # Always create medication_management capability with region US for prescribers
        FactoryBot.create(:care_capability, :medication_management, staffer: prescriber, region: Region.us)

        evaluator.medication_management_regions.each do |region|
          FactoryBot.create(:care_capability, :medication_management_ongoing, staffer: prescriber, region: region)
        end
      end
    end

    trait :biller do
      can_spectate_chats { false }
      can_chat_as_member_support { false }

      after :create do |biller|
        FactoryBot.create(:care_capability, :billing, staffer: biller, region: Region.us)
      end
    end

    trait :autism_spectrum_disorder_coach do
      can_spectate_chats { true }
      can_chat_as_member_support { false }

      transient do
        autism_spectrum_disorder_coaching_regions { [Region.us] }
        available_for_intakes { true }
        coaching_regions { [Region.us] }
        accepting_new_connect_accounts { true }
      end

      after :create do |coach, evaluator|
        evaluator.autism_spectrum_disorder_coaching_regions.each do |region|
          FactoryBot.create(:care_capability, :autism_spectrum_disorder_coaching, staffer: coach, region: region)
          FactoryBot.create(:care_capability, :autism_spectrum_disorder_coaching_intake, staffer: coach, region: region) if evaluator.available_for_intakes
          FactoryBot.create(:care_capability, :new_connect_account_coaching, staffer: coach, region: region) if evaluator.accepting_new_connect_accounts
        end

        evaluator.coaching_regions.each do |region|
          FactoryBot.create(:care_capability, :coaching, staffer: coach, region: region)
          FactoryBot.create(:care_capability, :coaching_ongoing, staffer: coach, region: region)
        end
      end
    end

    trait :admin do
      can_spectate_chats { true }
      can_chat_as_member_support { false }

      after :create do |admin|
        FactoryBot.create(:care_capability, :admin, staffer: admin, region: Region.us)
      end
    end

    trait :contract_administration do
      after :create do |admin_staffer|
        FactoryBot.create(:care_capability, :contract_administration, staffer: admin_staffer, region: Region.us)
      end
    end

    trait :developer do
      admin

      after :create do |admin_staffer|
        FactoryBot.create(:care_capability, :developer, staffer: admin_staffer, region: Region.us)
      end
    end

    trait :file_admin do
      admin

      after :create do |admin_staffer|
        FactoryBot.create(:care_capability, :file_admin, staffer: admin_staffer, region: Region.us)
      end
    end

    trait :marketing_admin do
      after :create do |admin_staffer|
        FactoryBot.create(:care_capability, :marketing_admin, staffer: admin_staffer, region: Region.us)
      end
    end

    trait :revenue_cycle do
      after :create do |staffer|
        FactoryBot.create(:care_capability, :revenue_cycle_management, staffer: staffer, region: Region.us)
      end
    end

    trait :trainee do
      trainee { true }
      after :create do |staffer|
        supervisor_staffer = FactoryBot.create(:staffer)
        FactoryBot.create(:supervisor_trainee_relationship, trainee: staffer, supervisor: supervisor_staffer)
      end
    end

    trait :cindy do
      first_name { "Cindy" }
      last_name { "Blackman" }
      email { "devops+dev-cblackman@hellobrightline.com" }
      timezone { "Pacific Time (US & Canada)" }
      acuity_calendar_id { 3981575 }
      with_availability_calculation
      member_support
      active
    end

    trait :david do
      first_name { "David" }
      last_name { "Bowie" }
      email { "devops+dev-dbowie@hellobrightline.com" }
      timezone { "Eastern Time (US & Canada)" }
      acuity_calendar_id { 5735060 }
      with_availability_calculation
      member_support
      active
    end

    trait :andy do
      first_name { "Andy" }
      last_name { "Sturmer" }
      email { "devops+dev-asturmer@hellobrightline.com" }
      timezone { "Central Time (US & Canada)" }
      acuity_calendar_id { 6135910 }
      with_availability_calculation
      welcome_specialist
      active
    end

    trait :roger do
      first_name { "Roger" }
      last_name { "Joseph Manning Jr." }
      email { "devops+dev-rjmanningjr@hellobrightline.com" }
      timezone { "Pacific Time (US & Canada)" }
      acuity_calendar_id { 6136725 }
      with_availability_calculation
      welcome_specialist
      active
    end

    trait :neil do
      first_name { "Neil" }
      last_name { "Peart" }
      email { "devops+dev-npeart@hellobrightline.com" }
      timezone { "Pacific Time (US & Canada)" }
      acuity_calendar_id { 3931073 }
      with_availability_calculation
      coach
      active
    end

    trait :martha do
      first_name { "Martha" }
      last_name { "Argerich" }
      email { "devops+dev-margerich@hellobrightline.com" }
      timezone { "Eastern Time (US & Canada)" }
      acuity_calendar_id { 5735013 }
      with_availability_calculation
      coach
      active
    end

    trait :sade do
      first_name { "Sade" }
      last_name { "Abu" }
      email { "devops+dev-sabu@hellobrightline.com" }
      timezone { "Eastern Time (US & Canada)" }
      acuity_calendar_id { 3981584 }
      with_availability_calculation
      therapy_regions { [Region.us] }
      therapist
      active
    end

    trait :harry do
      first_name { "Harry" }
      last_name { "Chapin" }
      email { "devops+dev-hchapin@hellobrightline.com" }
      timezone { "Eastern Time (US & Canada)" }
      acuity_calendar_id { 3981583 }
      with_availability_calculation
      therapist
      active
    end

    trait :sandy do
      first_name { "Sandy" }
      last_name { "Metz" }
      email { "devops+dev-smetz@hellobrightline.com" }
      personal_email { "devops+dev-personal-smetz@hellobrightline.com" }
      timezone { "Pacific Time (US & Canada)" }
      acuity_calendar_id { 8290094 }
      with_availability_calculation
      contract_therapist
      active
    end

    trait :marvin do
      first_name { "Marvin" }
      last_name { "Gaye" }
      email { "devops+dev-mgaye@hellobrightline.com" }
      timezone { "Pacific Time (US & Canada)" }
      acuity_calendar_id { 5734928 }
      with_availability_calculation
      therapist
      active
    end

    trait :kamasi do
      first_name { "Kamasi" }
      last_name { "Washington" }
      email { "devops+dev-kwashington@hellobrightline.com" }
      timezone { "Pacific Time (US & Canada)" }
      acuity_calendar_id { 3987125 }
      with_availability_calculation
      prescriber
      active
    end

    trait :cliff do
      first_name { "Cliff" }
      last_name { "Snyder" }
      email { "devops+dev-csnyder@hellobrightline.com" }
      timezone { "Pacific Time (US & Canada)" }
      acuity_calendar_id { nil }
      admin
      active
    end

    trait :bjork do
      first_name { "Björk" }
      last_name { "Guðmundsdóttir" }
      email { "devops+dev-bgudmundsdottir@hellobrightline.com" }
      timezone { "Pacific Time (US & Canada)" }
      acuity_calendar_id { nil }
      biller
      active
    end

    trait :courtney do
      first_name { "Courtney" }
      last_name { "Love" }
      email { "devops+dev-clove@hellobrightline.com" }
      timezone { "Eastern Time (US & Canada)" }
      acuity_calendar_id { 6587950 }
      with_availability_calculation
      autism_spectrum_disorder_coach
      active
    end

    trait :karen do
      first_name { "Karen" }
      last_name { "Orzolek" }
      email { "devops+dev-korzolek@hellobrightline.com" }
      timezone { "Pacific Time (US & Canada)" }
      acuity_calendar_id { 9942140 }
      active
    end

    trait :active do
      deactivated_at { nil }
    end

    trait :inactive do
      deactivated_at { DateTime.current }
    end

    trait :login_disabled do
      login_disabled_at { DateTime.current }
    end

    trait :available_coach do
      coaching_regions { [Region.us] }
      accepting_new_connect_accounts { true }
    end

    trait :with_availability_calculation do
      after(:create) do |staffer|
        FactoryBot.create(:provider_availability_calculation, staffer: staffer)
      end
    end

    trait :spanish_speaker do
      after(:create) do |staffer|
        FactoryBot.create(:care_capability, :spanish, staffer:, region: Region.us)
      end
    end

    # Per standard this is a "10-position, intelligence-free
    # numeric identifier (10-digit number)".
    # https://www.cms.gov/regulations-and-guidance/administrative-simplification/nationalprovidentstand
    #
    # Used for submitting claims with Candid. Therapists and
    # prescribers have their own. Coaching appointments use
    # David Grodberg's as he is a therapist.
    trait :with_national_provider_identifier do
      national_provider_identifier { Faker::Number.number(digits: 10) }
    end

    # Create a trait for each age range in the format of: works_with_X
    # This is down here so that it applies after care capabilities are created
    {
      **Staffer::AGE_RANGES.except("all").keys.map { [:"works_with_#{it}", [it]] }.to_h,
      works_with_all_ages: ["all"],
      works_with_young_children_and_children: ["young_children", "children"],
      works_with_children_and_preteens: ["children", "preteens"],
      works_with_preteens_and_teens: ["preteens", "teens"]
    }.each do |trait_name, patient_age_requirements|
      trait(trait_name) do
        after :create do |staffer|
          staffer.update(patient_age_requirements:)
        end
      end
    end

    initialize_with { Staffer.find_or_initialize_by(email:) }
  end
end
