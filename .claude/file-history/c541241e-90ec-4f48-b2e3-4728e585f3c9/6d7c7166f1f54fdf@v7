# frozen_string_literal: true

module Staffers
  module Accounts
    module Chats
      class StafferChatSelectorComponent < ViewComponent::Base
        attr_reader :account, :member, :staffer, :current_sendbird_user, :current_sendbird_chat_channel

        def initialize(account:, member:, staffer:, current_sendbird_user:, current_sendbird_chat_channel:)
          @account = account
          @member = member
          @staffer = staffer
          @current_sendbird_user = current_sendbird_user
          @current_sendbird_chat_channel = current_sendbird_chat_channel
        end

        def all_channels
          @all_channels ||= Chat::AccessibleStafferChannel.for(account: account, staffer: staffer, member: member)
        end

        def staffer_select_options
          unique_staffers.map do |channel|
            [staffer_display_name(channel), account_member_chat_path(account, member, channel.sendbird_chat_channel, sendbird_user_id: channel.sendbird_user)]
          end
        end

        def current_staffer_name
          channel = all_channels.find { |c| c.sendbird_user.id == current_sendbird_user.id }
          staffer_display_name(channel) if channel
        end

        def show_care_case_dropdown?
          return false unless current_sendbird_user

          channels_for_current_staffer.select { |c| c.sendbird_chat_channel.care_case_id.present? }
            .map { |c| c.sendbird_chat_channel.care_case_id }
            .uniq
            .count > 1
        end

        def care_case_select_options
          channels_for_current_staffer
            .select { |c| c.sendbird_chat_channel.care_case_id.present? }
            .group_by { |c| c.sendbird_chat_channel.care_case_id }
            .map do |care_case_id, channels|
              # Find the channel for this care case that matches the current chat_type to preserve context
              channel = channels.find { |c| c.sendbird_chat_channel.chat_type == current_sendbird_chat_channel.chat_type } || channels.first
              care_case = CareCase.find(care_case_id)
              [
                care_case.patient_preferred_name.to_s,
                account_member_chat_path(account, member, channel.sendbird_chat_channel, sendbird_user_id: channel.sendbird_user)
              ]
            end
        end

        def current_care_case_name
          return unless current_sendbird_chat_channel&.care_case_id

          care_case = CareCase.find(current_sendbird_chat_channel.care_case_id)
          care_case.patient_preferred_name
        end

        private

        def unique_staffers
          all_channels.group_by { |c| c.sendbird_user.id }.map { |_, channels| channels.first }
        end

        def channels_for_current_staffer
          all_channels.select { |c| c.sendbird_user.id == current_sendbird_user.id }
        end

        def staffer_display_name(channel)
          role = chat_type_to_role(channel.sendbird_chat_channel.chat_type)
          view_only_suffix = channel.sendbird_user.spectator? ? " - view only" : ""
          "#{channel.sendbird_user.nickname} (#{role})#{view_only_suffix}"
        end

        def chat_type_to_role(chat_type)
          case chat_type
          when Chat::Type.therapist then "therapist"
          when Chat::Type.prescriber then "prescriber"
          when Chat::Type.coach then "coach"
          when Chat::Type.member_support then "Member Support"
          when Chat::Type.care_guide then "care guide"
          else "staff"
          end
        end
      end
    end
  end
end
