# Chat Bug Fix Plan (TB-1786)

## Issues Identified

### Bug 1: `member_id: nil` Error in ReminderChatLinksComponent
**Error:** `ActionController::UrlGenerationError - No route matches {... member_id: nil ...}`

**Root Cause:** The `member_participant` method in `AccessibleStafferChannel` (line 103-109) returns `nil` when:
- The SendbirdChatChannel has no member sendbird_users with `role: Chat::Role.member`
- The member sendbird_user doesn't have a `participant_id` set
- No Member record exists with the participant_id

**Code Path:**
1. `app/components/staffers/reminder_chat_links_component.html.erb:4` calls `accessible_staffer_channel.member_participant`
2. The `member_participant` method queries for a Member but returns nil
3. The URL helper fails because it can't build a path with nil member_id

### Bug 2: Wrong Staffers Appearing in Care Team
**Issue:** Harry and Sade appear in care team dropdown when only Sade should appear (Sade is the only provider with scheduled intakes).

**Likely Root Cause:** The `staffer` method in `SendbirdChatChannel` (line 119-121) returns `staffers.first` without filtering for who is actually assigned to the care case. If both Harry and Sade are sendbird_users in the channel, both may appear.

**Note:** This needs clarification - where exactly is the "care team" being displayed? Is it:
- The chat dropdown in TabsComponent?
- The care case sidebar?
- Another location?

---

## Proposed Fixes

### Fix 1: Handle nil member_participant in ReminderChatLinksComponent

**Option A (Recommended):** Filter out channels without member_participant
```ruby
# In reminder_chat_links_component.rb
def accessible_staffer_channels
  all_channels = Chat::AccessibleStafferChannel.for_all_members_scoped_to_staffer(account: account, staffer: staffer)
    .reject { |channel| channel.member_participant.nil? }  # Add filter
  # ... rest of method
end
```

**Option B:** Use the `path` method which would need to handle nil gracefully
```ruby
# In accessible_staffer_channel.rb
def path
  return nil unless member_participant  # Guard clause
  account_member_chat_path(account, member_participant, sendbird_chat_channel, ...)
end
```

### Fix 2: TBD - Needs Clarification

---

## Files to Modify

1. `app/components/staffers/reminder_chat_links_component.rb` - Filter channels with nil member_participant
2. Possibly `app/models/chat/accessible_staffer_channel.rb` - Add guard in `path` method
3. TBD based on Bug 2 clarification

## Testing

- Run existing spec: `spec/components/staffers/reminder_chat_links_component_spec.rb`
- Add test case for channel with nil member_participant
