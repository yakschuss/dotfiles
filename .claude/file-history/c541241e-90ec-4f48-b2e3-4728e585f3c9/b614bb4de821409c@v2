# frozen_string_literal: true

class CareCases::ChatsController < BaseController
  include CareCaseScoped

  caseload_sidebar

  def index
    @channels = channels
    @tab = tab

    @member = member
    @accessible_channel = @channels[@tab.to_sym].first
  end

  def show
    channel = SendbirdChatChannel.for(account: current_care_case.account, member: member).find_by(id: params[:id])

    authorize channel, policy_class: ChatPolicy
    accessible_channel = Chat::AccessibleStafferChannel.new(sendbird_chat_channel: channel, sendbird_user: staffer_sendbird_user(channel))

    render Staffers::CareCases::Chats::AccessibleChannelComponent.new(accessible_channel: accessible_channel, member: member)
  end

  private

  def channels
    {
      caregiver: channels_for_member(current_care_case.caregiver),
      teen: teen_channels
    }
  end

  def teen_channels
    return [] unless get_teen_channels?

    channels_for_member(current_care_case.patient)
  end

  def channels_for_member(member)
    Chat::AccessibleStafferChannel.for(account: current_care_case.account, staffer: current_staffer, member: member)
      .select { |channel| channel.sendbird_chat_channel.care_case_id == current_care_case.id }
  end

  def get_teen_channels?
    ::Rules::CareCase::TeenCase.new(current_care_case).call
  end

  def tab
    allowed_tabs = %w[teen caregiver]
    params[:tab].presence_in(allowed_tabs) || "caregiver"
  end

  def member
    if tab == "caregiver"
      current_care_case.caregiver
    else
      current_care_case.patient
    end
  end

  def staffer_sendbird_user(channel)
    Chat::AccessibleSendbirdUsers.new(current_staffer).for_channel(channel).find_by(id: params[:sendbird_user_id])
  end
end
