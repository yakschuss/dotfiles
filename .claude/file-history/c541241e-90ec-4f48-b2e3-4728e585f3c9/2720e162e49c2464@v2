# frozen_string_literal: true

module Staffers
  module Accounts
    module Members
      class MemberTabsComponent < ViewComponent::Base
        include TabHelpers

        attr_reader :account, :member, :staffer, :tab

        def initialize(account:, member:, staffer:, tab: "overview")
          @account = account
          @member = member
          @staffer = staffer
          @tab = tab
        end

        def tab_items
          [
            build_tab_item({name: "Member overview", param: "overview", link: {href: account_member_path(account, member)}}),
            build_tab_item({name: "App usage", param: "app_usage", link: {href: account_member_connect_usage_path(account, member)}}),
            chat_tab,
            outreach_tab
          ].compact
        end

        private

        def chat_tab
          sorted_channels = Chat::AccessibleStafferChannel.for(account: account, staffer: staffer, member: member, prefer_unmuted: true)
          return nil if sorted_channels.empty?

          first_channel = sorted_channels.first
          has_unread = sorted_channels.any?(&:unread_messages?)

          build_tab_item({
            name: "Chat",
            param: "chat",
            link: {href: account_member_chat_path(account, member, first_channel.sendbird_chat_channel, sendbird_user_id: first_channel.sendbird_user)},
            display_notification: has_unread,
            data: {turbo: false, turbolinks: false}
          })
        end

        def outreach_tab
          return unless ::Accounts::Members::OutreachPolicy.new(staffer, account).show?

          build_tab_item({name: "Outreach", param: "outreach", link: {href: account_member_outreach_path(account, member)}})
        end

        def account_member
          @_account_member ||= AccountMember.new(account: account, member: member)
        end
      end
    end
  end
end
