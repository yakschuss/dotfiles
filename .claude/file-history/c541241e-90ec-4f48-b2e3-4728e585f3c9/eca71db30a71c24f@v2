# frozen_string_literal: true

# Sync Carol's therapist channels to Sendbird

therapist = Staffer.find('6a4f7f3c-b9f4-4ea8-9e8e-47bcc9cb334e')
carol = Member.find('53054fd5-ab2a-44d1-9040-40d0b9798425')
account = carol.accounts.first

care_cases = carol.care_cases.to_a

puts "Syncing therapist channels to Sendbird..."
puts ''

care_cases.each do |care_case|
  puts "Care case: #{care_case.id}"

  chat_id = Chat::ChannelId.therapist(member: carol, care_case: care_case, staffer: therapist)

  participants = [
    Chat::MemberParticipant.new(carol),
    Chat::StafferParticipant.new(therapist)
  ]

  begin
    channel = Chat::DesiredChannel.ensure!(
      account: account,
      care_case: care_case,
      chat_id: chat_id,
      chat_type: Chat::Type.therapist,
      participants: participants
    )

    puts "  âœ“ Channel synced: #{channel.id}"
    puts "    URL: #{channel.url}"
  rescue => e
    puts "  Error: #{e.message}"
    puts e.backtrace.first(5)
  end

  puts ''
end

puts 'Done!'
puts ''
puts 'Test URL:'
first_channel = SendbirdChatChannel.find_by(account: account, chat_type: Chat::Type.therapist)
therapist_sendbird_user = SendbirdUser.find_by(participant: therapist)
puts "http://reef.dev-hellobrightline.com:3000/accounts/#{account.id}/members/#{carol.id}/chats/#{first_channel.id}?sendbird_user_id=#{therapist_sendbird_user.id}"
