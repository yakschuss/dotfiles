# frozen_string_literal: true

module SlotRecapture
  class OpportunityCreator
    Result = Struct.new(:opportunity, :failed, :errors, keyword_init: true) do
      def success?
        !failed
      end
    end

    def call(appointment:, appointment_cancelation:)
      lead_time_hours = ((appointment.start_time - Time.current) / 1.hour).to_i

      opportunity = Opportunity.create(
        cancelled_appointment: appointment,
        staffer_id: appointment.staffer_id,
        appointment_type_id: appointment.appointment_type_id,
        root_appointment_type_id: appointment.appointment_type.root_appointment_type_id,
        clinic_id: appointment.clinic_id,
        region_id: appointment.region_id,
        start_time: appointment.start_time,
        lead_time_hours: lead_time_hours,
        status: Opportunity::Status.pending_verification
      )

      if opportunity.persisted?
        Result.new(opportunity: opportunity, failed: false, errors: [])
      else
        Result.new(opportunity: nil, failed: true, errors: opportunity.errors.full_messages)
      end
    end
  end
end
