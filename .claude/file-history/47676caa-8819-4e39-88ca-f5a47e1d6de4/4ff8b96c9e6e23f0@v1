# frozen_string_literal: true

module SlotRecapture
  class OutreachAttemptsController < BaseController
    layout "application_strapless"

    before_action :ensure_feature_enabled
    before_action :set_opportunity
    before_action :set_entry

    def new
      render Staffers::SlotRecapture::PhoneCallOutreachModal.new(
        opportunity: @opportunity,
        entry: @entry
      )
    end

    def create
      if params[:mode] == WaitList::OutreachAttempt::Mode.phone_call
        log_phone_call
      else
        flash_message = Staffers::FlashMessage.new("Unable to capture outreach attempt, please try again", type: :error)
        render turbo_stream: turbo_stream.update(:flash, flash_message)
      end
    end

    private

    def ensure_feature_enabled
      raise ActiveRecord::RecordNotFound unless Flipper.enabled?(:slot_recapture_enabled)
    end

    def set_opportunity
      @opportunity = Opportunity.find(params[:opportunity_id])
      authorize @opportunity, policy_class: OpportunityPolicy
    end

    def set_entry
      @entry = WaitList::Entry.find(params[:wait_list_entry_id])
    end

    def outreach_event_params
      params.require(:outreach_event).permit(:event_name)
    end

    def log_phone_call
      outreach_attempt = @entry.outreach_attempts.phone_call.create(
        initiated_at: Time.current,
        slot_recapture_opportunity: @opportunity
      )
      WaitList::Api.track_outreach_event(outreach_attempt:, event_name: outreach_event_params[:event_name])

      @opportunity.offered! if @opportunity.open?

      flash[:success] = "Phone call logged"
      redirect_to slot_recapture_opportunity_path(@opportunity), turbo_frame: :_top
    end
  end
end
