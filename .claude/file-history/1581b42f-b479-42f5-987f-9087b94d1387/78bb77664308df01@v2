# frozen_string_literal: true

require "rails_helper"

RSpec.feature "appointment scheduling request", type: :feature, js: true, scope: :members do
  include TestDoubles::Acuity

  def setup_test_data
    start_time = Time.zone.now.tomorrow.to_date
    staffer = FactoryBot.create(:staffer, :sade, acuity_calendar_id: 80283)
    member = FactoryBot.create(:member, :registered, timezone: "Pacific Time (US & Canada)")
    account = FactoryBot.create(:account, caregivers: [member], owner: member)
    chat_channel = FactoryBot.create(:sendbird_chat_channel, :member_support, account: account)
    FactoryBot.create(:sendbird_chat_channel_membership, :with_message, sendbird_chat_channel: chat_channel, sendbird_user: member.sendbird_user)
    care_case = FactoryBot.create(:care_case, patient: member, account: account)
    appointment_scheduling_request = FactoryBot.create(:appointment_scheduling_request, care_case: care_case, member: member, staffer: staffer)

    {
      start_time: start_time,
      staffer: staffer,
      member: member,
      care_case: care_case,
      appointment_scheduling_request: appointment_scheduling_request
    }
  end

  context "with new calendaring API (feature flag enabled)" do
    before do
      Flipper.enable(:change_calendaring_times_api)
    end

    scenario "able to successfully schedule" do
      data = setup_test_data
      expect_acuity_available_dates(dates: [data[:start_time]])
      appointment_time = Time.zone.now.tomorrow.change({hour: 9, min: 0, sec: 0})
      slots = [Calendaring::AvailableTimes::Slot.new(appointment_time, data[:staffer], data[:appointment_scheduling_request].appointment_type)]
      slot_collection = Calendaring::AvailableTimes::Slot::Collection.new(slots)
      expect(Calendaring::Api::Availability).to receive(:times).with(
        hash_including(
          root_appointment_type: data[:appointment_scheduling_request].appointment_type.root_appointment_type
        )
      ).and_return(slot_collection)
      expect_acuity_appointment_to_be_created(email: data[:member].email)
      log_in_as_member(data[:member])

      visit members_care_case_appointment_scheduling_request_path(data[:appointment_scheduling_request].care_case, data[:appointment_scheduling_request])
      expect(page).to have_content(I18n.l(data[:start_time], format: :weekday_and_short_date))
      click_on("9:00am")
      click_on("Book appointment")

      expect(page).to have_content("Your appointment is booked. See page below for details.")
      expect(page.current_path).to eq(members_appointments_path)
    end
  end

  context "with legacy calendaring API (feature flag disabled)" do
    before do
      Flipper.disable(:change_calendaring_times_api)
    end

    scenario "able to successfully schedule" do
      data = setup_test_data
      expect_acuity_available_dates(dates: [data[:start_time]])
      appointment_time = Time.zone.now.tomorrow.change({hour: 9, min: 0, sec: 0})
      expect_acuity_availability(times: [appointment_time])
      expect_acuity_appointment_to_be_created(email: data[:member].email)
      log_in_as_member(data[:member])

      visit members_care_case_appointment_scheduling_request_path(data[:appointment_scheduling_request].care_case, data[:appointment_scheduling_request])
      expect(page).to have_content(I18n.l(data[:start_time], format: :weekday_and_short_date))
      click_on("9:00am")
      click_on("Book appointment")

      expect(page).to have_content("Your appointment is booked. See page below for details.")
      expect(page.current_path).to eq(members_appointments_path)
    end
  end
end
