# frozen_string_literal: true

# == Schema Information
#
# Table name: wait_list_outreach_attempts
#
#  id                            :uuid             not null, primary key
#  expires_at                    :datetime
#  initiated_at                  :datetime
#  mode                          :string           default("email"), not null
#  offer_type                    :string           default("general"), not null
#  staffer_ids                   :string           default([]), is an Array
#  created_at                    :datetime         not null
#  updated_at                    :datetime         not null
#  slot_recapture_opportunity_id :uuid
#  wait_list_entry_id            :uuid
#
# Indexes
#
#  idx_on_slot_recapture_opportunity_id_2c2b69b89b          (slot_recapture_opportunity_id)
#  index_wait_list_outreach_attempts_on_wait_list_entry_id  (wait_list_entry_id)
#
# Foreign Keys
#
#  fk_rails_...  (slot_recapture_opportunity_id => slot_recapture_opportunities.id)
#  fk_rails_...  (wait_list_entry_id => wait_list_entries.id)
#
module WaitList
  class OutreachAttempt < ApplicationRecord
    Mode = Enum.new(%w[email phone_call])
    OfferType = Enum.new(%w[general slot_offer])

    belongs_to :entry, class_name: "WaitList::Entry", foreign_key: "wait_list_entry_id"
    belongs_to :slot_recapture_opportunity,
      class_name: "SlotRecapture::Opportunity",
      optional: true
    has_many :events, class_name: "WaitList::OutreachAttempt::Event", foreign_key: "wait_list_outreach_attempt_id", dependent: :destroy

    enum :mode, Mode.as_string_map
    enum :offer_type, OfferType.as_string_map, default: OfferType.general

    scope :slot_offers, -> { where(offer_type: OfferType.slot_offer) }

    scope :for_care_case, ->(care_case) { joins(entry: :care_case).where(wait_list_entries: {care_case_id: care_case.id}) }
    scope :active, -> { where("coalesce(expires_at > ?, true)", Time.zone.now) }
    scope :most_recent, -> { order(initiated_at: :desc) }

    TTL = 48.hours # Time to live

    def staffers
      Staffer.where(id: staffer_ids)
    end

    def expired?
      return false unless expires_at.present?
      expires_at <= Time.zone.now
    end
  end
end
