module Chat
  class ProviderChannel
    include Invokable
    include EventSystem::Listener

    invokable_via :ensure!, :freeze!

    on(AddedStafferToCareCaseEvent) do |event|
      event => {care_case:, staffer:}
      care_case.eligible_members_for_provider_channel.each do |member|
        ensure!(care_case:, member:, staffer:)
      end
    end

    on(RemovedStafferFromCareCaseEvent) do |event|
      event => {care_case:, staffer:}
      care_case.eligible_members_for_provider_channel.each do |member|
        freeze!(care_case:, member:, staffer:)
      end
    end

    on(CareCaseDischargedEvent) do |event|
      event => {care_case:, discharge:}
      care_case.eligible_members_for_provider_channel.each do |member|
        freeze!(care_case:, member:, staffer: discharge.staffer)
      end
    end

    attr_reader :care_case, :member, :staffer, :account_member
    delegate :account, to: :care_case

    def initialize(care_case:, member:, staffer:)
      @care_case = care_case
      @member = member
      @staffer = staffer
      @account_member = AccountMember.new(account:, member:)
    end

    def ensure!
      return unless is_therapist? || is_prescriber?
      return if supervisor_with_trainee_on_case?

      if existing_channel_for_staffer && care_case.staffers.include?(staffer) && !discharged?
        Chat::Channel.new(existing_channel_for_staffer).unfreeze!
      end

      Chat::DesiredChannel.ensure!(account:, care_case:, participants: [member_participants, staffer_participant].flatten.compact, chat_id: chat_id, chat_type: chat_type, change_handler:)
    end

    def freeze!
      channel = existing_channel_for_staffer
      return unless channel
      return unless is_therapist? || is_prescriber?

      Chat::DesiredChannel.ensure!(account:, care_case:, participants: member_participants, chat_id: chat_id, chat_type: chat_type, change_handler:)
      Chat::Channel.new(channel).freeze!
    end

    private

    def member_participants
      account_member.caregiver? ? caregiver_participants : [Chat::MemberParticipant.new(member)]
    end

    def staffer_participant
      Chat::StafferParticipant.new(staffer)
    end

    def caregiver_participants
      account.caregivers.map { Chat::MemberParticipant.new(it) }
    end

    def chat_id
      if is_therapist?
        Chat::ChannelId.therapist(member: chat_owner, care_case:, staffer:)
      elsif is_prescriber?
        Chat::ChannelId.prescriber(member: chat_owner, care_case:, staffer:)
      end
    end

    def chat_owner
      account_member.caregiver? ? account.owner : member
    end

    def chat_type
      if is_therapist?
        Chat::Type.therapist
      elsif is_prescriber?
        Chat::Type.prescriber
      end
    end

    def is_therapist?
      staffer.has_capability?(Capability.therapy)
    end

    def is_prescriber?
      # default to therapist chat if a staffer has both capabilities
      staffer.has_capability?(Capability.medication_management) && !is_therapist?
    end

    def discharged?
      Discharge.where(care_case:, staffer:).exists?
    end

    def change_handler
      Chat::ProviderChannelChanges.new(account:, care_case:, member:)
    end

    def existing_channel_for_staffer
      @existing_channel_for_staffer ||= SendbirdChatChannel.find_by(account:, chat_id:)
    end
  end
end
