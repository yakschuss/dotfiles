# frozen_string_literal: true

module WaitList
  module Entries
    class OutreachAttemptsController < BaseController
      layout "application_strapless"
      before_action :find_entry, only: [:index, :new, :create, :destroy]

      def index
        render Staffers::WaitList::OutreachAttemptsModal.new(@entry)
      end

      def new
        render Staffers::WaitList::PhoneCallOutreachModal.new(@entry)
      end

      def create
        if params[:mode] == WaitList::OutreachAttempt::Mode.phone_call
          log_phone_call
        else
          # TODO: This should probably be a form error since we are inside a modal
          flash_message = Staffers::FlashMessage.new("Unable to capture outreach attempt, please try again", type: :error)
          render turbo_stream: turbo_stream.update(:flash, flash_message)
        end
      end

      def destroy
        outreach_attempt = @entry.outreach_attempts.find(params[:id])
        if outreach_attempt.phone_call? && outreach_attempt.destroy
          render turbo_stream: [
            turbo_stream.replace(:modal, Staffers::WaitList::OutreachAttemptsModal.new(@entry)),
            turbo_stream.update(:flash, Staffers::FlashMessage.new("Outreach attempt deleted", type: :success))
          ]
        else
          # TODO: This should probably be a form error since we are inside a modal
          flash_message = Staffers::FlashMessage.new("Unable to delete outreach attempt", type: :error)
          render turbo_stream: turbo_stream.update(:flash, flash_message)
        end
      end

      private

      def find_entry
        @entry = WaitList::Entry.find(params[:entry_id])
      end

      def outreach_event_params
        params.require(:outreach_event).permit(:event_name)
      end

      def filter_params
        params.fetch(:filters, {}).permit(:status, :root_appointment_type_id, :priority, region_id: [], payer_id: [], clinic_id: []).to_h.symbolize_keys
      end

      def log_phone_call
        # TODO: Should `initiated_at` + `event_at` default to current time?
        outreach_attempt = @entry.outreach_attempts.phone_call.create(
          initiated_at: Time.current,
          slot_recapture_opportunity: slot_recapture_opportunity
        )
        WaitList::Api.track_outreach_event(outreach_attempt:, event_name: outreach_event_params[:event_name])

        slot_recapture_opportunity&.offered! if slot_recapture_opportunity&.open?

        flash[:success] = "Phone call logged"
        redirect_to redirect_path_after_outreach, turbo_frame: :_top
      end

      def slot_recapture_opportunity
        return @slot_recapture_opportunity if defined?(@slot_recapture_opportunity)

        @slot_recapture_opportunity = if params[:slot_recapture_opportunity_id].present?
          opportunity = SlotRecapture::Opportunity.find(params[:slot_recapture_opportunity_id])
          authorize opportunity, policy_class: SlotRecapture::OpportunityPolicy
          opportunity
        end
      end

      def redirect_path_after_outreach
        if slot_recapture_opportunity.present?
          slot_recapture_opportunity_path(slot_recapture_opportunity)
        else
          wait_list_entries_path(filters: filter_params)
        end
      end
    end
  end
end
