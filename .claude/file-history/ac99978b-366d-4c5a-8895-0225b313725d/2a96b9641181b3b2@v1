# frozen_string_literal: true

module Members
  module CareNavigation
    class RecommendationsController < BaseController
      include CareNavigationJourneyNavigation
      include CareCaseScoped

      layout "members/onboarding"

      before_action :set_journey
      before_action :ensure_service_line_recommendation_exists, only: [:index]
      before_action :kids_coaching_exclusion_check, only: [:index]

      show_nav_links([:home], only: [:index])

      def index
        @journey.complete_step!("recommendation")
        @offerings = ::CareNavigation::EligibleOfferings.new(care_case: current_care_case)
      end

      private

      def kids_coaching_exclusion_check
        return unless current_care_case.coaching_excluded?
        return if member_experience_configuration.care_case_covered_by_program? # we don't want to show trapdoor for california members
        return unless trapdoor_age.cover?(current_care_case.patient_age)

        if @journey.most_recent_step_completed == "recommendation"
          redirect_to members_care_case_care_navigation_trapdoors_path(current_care_case)
        else
          redirect_to new_members_care_case_care_navigation_trapdoor_path(current_care_case)
        end
      end

      def set_journey
        @journey = ::CareNavigation::Journey.for_care_case(current_care_case)
      end

      def member_experience_configuration
        @member_experience_configuration ||= MemberExperience::Configuration.new(account: current_care_case.account, care_case: current_care_case)
      end

      def trapdoor_age
        (0..1)
      end
    end
  end
end
