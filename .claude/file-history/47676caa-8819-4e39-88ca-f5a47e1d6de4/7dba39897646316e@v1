<% content_for :head do %>
  <meta name="turbo-refresh-method" content="morph">
  <meta name="turbo-refresh-scroll" content="preserve">
<% end %>

<div class="flex items-center justify-between mb-4">
  <h1>Waitlist</h1>
  <% if Flipper.enabled?(:slot_recapture_enabled) %>
    <%= link_to "Slot Recapture", slot_recapture_opportunities_path, class: "prism-button-secondary" %>
  <% end %>
</div>

<div data-controller="forms events">
  <%= link_to wait_list_entries_path, class: "prism-link prism-text-small block mb-4" do %>
    Reset filters
  <% end %>
  <div class="mb-8">
    <%= wave_form_with scope: :filters, method: :get, data: {turbo: true, forms_target: :submittable}, class: "flex flex-wrap items-center gap-4" do |f| %>
      <%= f.collection :select, :status, WaitList::Entry::Status.as_select_options, :first, :last,
            include_blank: "Any", selected: filter_params[:status], wrapper_class: "w-auto shrink-0",
            html_options: {data: {action: "change->forms#requestSubmit"}, class: "pr-8"} %>
      <%= f.field :checkbox_multiselect, :region_id,
            wrapper_class: "w-auto shrink-0",
            wrapper_data: {action: "checkbox-multiselect:input->forms#requestSubmit"},
            label: "State",
            placeholder: "Any",
            dropdown_height: "max-h-64",
            options: SupportedRegion.all.sort_by(&:name).map { |region| [region.name, region.id.to_s] },
            selected: Array(filter_params[:region_id]),
            input_class: "pr-8" %>
      <%= f.field :checkbox_multiselect, :clinic_id,
            wrapper_class: "w-auto shrink-0",
            wrapper_data: {action: "checkbox-multiselect:input->forms#requestSubmit"},
            label: "Preferred clinic",
            placeholder: "Any",
            options: Clinic.sorted_by_type.map { |clinic| [clinic.name, clinic.id.to_s] },
            selected: Array(filter_params[:clinic_id]),
            input_class: "pr-8" %>
      <%= f.collection :select, :root_appointment_type_id, ::WaitList::Api.root_appointment_types, :id, :name_with_care_model,
            include_blank: "Any", selected: filter_params[:root_appointment_type_id], label: "Appointment type", wrapper_class: "w-auto shrink-0",
            html_options: {data: {action: "change->forms#requestSubmit"}, class: "pr-8"} %>
      <%= f.field :check_box, :priority,
            checked: filter_params[:priority] == true,
            label: inline_svg_tag("icons/rating-star.svg", class: "w-5 h-5 mb-2 fill-yellow-800 stroke-yellow-800"),
            class: "w-5 h-5 mb-1", wrapper_class: "w-auto shrink-0 mt-8",
            data: {action: "change->forms#requestSubmit"} %>

      <%= f.field :checkbox_multiselect, :payer_id,
            wrapper_class: "w-auto shrink-0",
            wrapper_data: {action: "checkbox-multiselect:input->forms#requestSubmit"},
            label: "Payer",
            placeholder: "Any",
            searchable: true,
            dropdown_height: "max-h-96",
            options: Payer.ordered_with_dtc_first.map { |payer| [payer.name, payer.id.to_s] },
            selected: Array(filter_params[:payer_id]),
            input_class: "pr-8" %>
    <% end %>
  </div>
  <table class="table table-sm table-striped">
      <thead>
        <th>
          <div class="ml-0.25">
            <%= link_to({
                  params: {
                    filters: filter_params,
                    sort: {sort_field: :priority,
                           sort_order: ((sort_params[:sort_field] == "priority" && sort_params[:sort_order] == "desc") ? "asc" : "desc")}
                  }
                }, class: "flex items-center gap-1") do %>
              <%= inline_svg_tag("icons/rating-star.svg", class: "w-4 h-4 fill-blue-700 stroke-blue-700 mb-1") %>
              <%= sort_icon(field: "priority") %>
            <% end %>
          </div>
        </th>
        <th>Care case</th>
        <th>
          <%= link_to params: {filters: filter_params, sort: {sort_field: :outreaches, sort_order: ((sort_params[:sort_field] == "outreaches" && sort_params[:sort_order] == "desc") ? "asc" : "desc")}} do %>
            Status
            <%= sort_icon(field: "outreaches") %>
          <% end %>
        </th>
        <th>State / clinic</th>
        <% if filter_params[:root_appointment_type_id].blank? %>
          <th>Appointment type</th>
        <% end %>
        <th>
          <%= link_to params: {filters: filter_params, sort: {sort_field: :added_at, sort_order: ((sort_params[:sort_field] == "added_at" && sort_params[:sort_order] == "desc") ? "asc" : "desc")}} do %>
            Added
            <%= sort_icon(field: "added_at") %>
          <% end %>
        </th>
        <% if filter_params[:status] == WaitList::Entry::Status.removed %>
          <th>
            <%= link_to params: {filters: filter_params, sort: {sort_field: :removed_at, sort_order: ((sort_params[:sort_field] == "removed_at" && sort_params[:sort_order] == "desc") ? "asc" : "desc")}} do %>
              Removed on
              <%= sort_icon(field: "removed_at") %>
            <% end %>
          </th>
          <th>Removed reason</th>
        <% end %>
        <th>Notes</th>
        <th>Actions</th>
      </thead>

      <tbody>
        <% @entries.each do |entry| %>
          <tr data-test-id="<%= dom_id(entry) %>">
            <td>
              <div class="ml-0.5">
                <%= button_to wait_list_entry_path(entry), method: :put, params: {wait_list_entry: {priority: !entry.priority}}, form: {data: {turbo: true}}, class: "cursor-pointer" do %>
                  <% if entry.priority %>
                    <%= inline_svg_tag("icons/rating-star.svg", class: "w-4 h-4 fill-yellow-800 stroke-yellow-800", data: {priority: true}) %>
                  <% else %>
                    <%= inline_svg_tag("icons/rating-star.svg", class: "w-4 h-4 stroke-gray-700", data: {priority: false}) %>
                  <% end %>
                <% end %>
              </div>
            </td>
            <td>
              <div class="prism-text-small prism-text-bold"><%= link_to entry.care_case.brightline_id, care_case_path(entry.care_case) %></div>
              <div><%= entry.caregivers.map(&:full_name).join(", ") %> (caregivers)</div>
              <div><%= entry.patient.full_name %> (<%= entry.patient.age %> years old)</div>
              <% if payer = Eligibility::Api::CoveredEntity.active_health_plan_benefit_for_care_case(entry.care_case)&.payer.presence %>
                <div>Payer: <%= payer.name %></div>
              <% end %>
            </td>
            <td>
              <div class="prism-text-small prism-text-bold"><%= entry.humanized_status %></div>
              <%= render Staffers::WaitList::OutreachAttemptSummary.new(entry.outreach_attempts) %>
            </td>
            <td>
              <div class="prism-text-small prism-text-bold"><%= entry.region.short_name %></div>
              <div>
                <%= safe_join(entry.clinics.map { |clinic| tag.span(clinic.name, class: "whitespace-nowrap") }, ", ") %>
              </div>
            </td>
            <% if filter_params[:root_appointment_type_id].blank? %>
              <td><%= entry.root_appointment_type.name_with_care_model %></td>
            <% end %>
            <td><%= entry.added_at.strftime("%-m/%-d/%Y") %></td>
            <% if filter_params[:status] == WaitList::Entry::Status.removed %>
              <td><%= entry.removed_at.strftime("%b %e, %Y") %></td>
              <td><%= entry.humanized_removed_reason %></td>
            <% end %>
            <td class="max-w-xs">
              <div class="flex items-start">
                <%= turbo_frame_tag dom_id(entry, :notes) do %>
                  <p><%= entry.notes %></p>
                <% end %>
              </div>
            </td>
            <td>
              <div class="my-2 space-y-4">
                <div class="whitespace-nowrap">
                  <% phone_call_count = entry.outreach_attempts.phone_call.size %>
                  <% text = (phone_call_count == 0) ? "Log call" : "Log call ##{phone_call_count + 1}" %>
                  <%= link_to text, new_wait_list_entry_outreach_attempt_path(entry.id, mode: WaitList::OutreachAttempt::Mode.phone_call, filters: filter_params), class: "prism-button-secondary", data: {turbo: true, turbo_frame: :modal} %>
                </div>

                <div class="whitespace-nowrap">
                  <%= link_to "Edit", edit_wait_list_entry_path(entry), class: "prism-button-secondary", data: {turbo: true, turbo_frame: :modal} %>
                </div>

                <div class="whitespace-nowrap">
                  <%= link_to "Remove", new_wait_list_entry_removal_path(entry), class: "prism-button-secondary text-red-700", data: {turbo: true, turbo_frame: :modal} %>
                </div>
              </div>
            </td>
          </tr>
        <% end %>
      </tbody>
  </table>
</div>

<div class="pagy-nav-wrapper">
  <%== pagy_nav(@pagy) %>
</div>
