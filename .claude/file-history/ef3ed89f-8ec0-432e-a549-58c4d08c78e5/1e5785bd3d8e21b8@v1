# frozen_string_literal: true

module Wisper
  module Broadcasters
    class SendBroadcaster
      def broadcast(listener, publisher, event, *args, **)
        if Hash === args.last
          listener.public_send(event, *args[0..-2], **args.last, **)
        else
          listener.public_send(event, *args, **)
        end
      end
    end
  end
end

REEF_EVENT_LISTENERS = %w[
  Account
  AccountTeam::AssignBackupCoachJob
  AccountTeam::AutomaticCoachAssignment
  AccountTeam::BackupCoachAssignmentAcknowledgement
  AccountTeam::BackupCoachUnassignmentAcknowledgement
  AccountTeam::BackupCoachPrompt
  AccountTeam::CareGuideSwap
  AccountTeam::MemberSupport
  Assignments::ScheduledAssessment
  Billing::FinishedAppointment
  CaregiverInvitationToken::TrackInvite
  Calendaring::Acuity::AppointmentManager
  Calendaring::AcuityCache
  Calendaring::AppointmentSlot::DischargeRelease
  Calendaring::Availability::ProviderRegularHours
  Calendaring::ReefLinks
  Calendaring::NewPatientLimitAdjustment
  Calendaring::SchedulingReminders
  CareCase
  CareCase::ClinicAssignment
  CareCase::ReferralReminders
  CareCaseRoles::RemoveMemberFromCareCaseAppointments
  CareGuide::ReferralService
  CareGuideSwapChatAssignment
  CareJourney::Workflows::DischargeWorkflow
  CareJourney::Workflows::IntakeWorkflow
  CareJourney::Workflows::InternalReferralWorkflow
  CareJourney::Workflows::ReengagedMemberWorkflow
  CareJourney::Workflows::UnestablishedDisengagedMemberWorkflow
  CareNavigation::Journey
  Chat::AccountInfrastructure
  Chat::CoachChannel
  Chat::CoachChannelNotification
  Chat::DeletedMember
  Chat::InitialOutreachMessageScheduler
  Chat::MemberSupportConversationResponse
  Chat::NewCareGuideMessage
  Chat::NewMemberSupportConversationMessage
  Chat::ProviderChannel
  Chat::Providers::Responder
  Chat::Safety::Monitor
  Chat::UnclaimIdleConversationJob
  ClinicalTeam::Coach
  ClinicalTeam::SupervisorCareCaseSync
  CoachSwapMessages
  Coco::ActivityLog
  Collection::BilledAsClaim
  Collection::BilledAsPatientResponsibility
  Compliance::CareCaseConsentReport
  Compliance::MemberConsentReport
  Connect::ContentView
  Contractors::AppointmentAcceptances
  CoverageContext::RemovePaymentFormAssignmentsJob
  EmailAddressSyncJob
  EmailAddressSync::AcuityEmail
  Exercise::ProcessFearLadderResults
  Healthie::Appointment
  Healthie::Patient
  Healthie::Patient::CareFolders
  Healthie::Staffer
  Iterable::DataSynchronization::Account
  Iterable::DataSynchronization::Appointment
  Iterable::DataSynchronization::AppointmentEvent
  Iterable::DataSynchronization::CareCase
  Iterable::DataSynchronization::Coverage
  Iterable::DataSynchronization::Member
  Iterable::Event::Account::Created
  Iterable::Event::CareCase::NonCommitmentIndicated
  Iterable::Event::CareCase::OperationalStatusChanged
  Iterable::Event::ClinicalReferral::Initiated
  Iterable::Event::InternalReferral::Initiated
  Iterable::Event::IntakeBooking::Completed
  Iterable::Event::PhoneDesk::Call::DidNotConnect
  Iterable::Event::WaitList::Joined
  Iterable::PostAppointmentSurveyEmail
  Iterable::UpdateDuplicateContactJob
  MemberAction::ActivatableEventListener
  Member::UpdateAuth0Email
  Mirah::CaregiverSyncJob
  MoodTracking::Enrollment::Update
  MoodTracking::AutomaticEnrollment
  MoodTracking::AutomaticUnenrollment
  MultiFactorAuthentication::OptIn
  Notification::Appointment::IncompletePaperwork
  Notification::Appointment::IntakeAppointmentCanceledJourney
  Notification::Appointment::IntakeAppointmentNoShowedJourney
  Notification::Appointment::IssueAmazonSessionProviderEmail
  Notification::Appointment::PostIntakeSurvey
  Notification::Assignment::AssessmentReminder
  Notification::Assignment::Reminder
  Notification::CareCase::PostDischargeSurvey
  Notification::Paperwork::NewPaperwork
  Notification::Appointment::SchedulingFollowUpReminder
  Notification::Appointment::SchedulingNotification
  Notification::Appointment::LegacySchedulingNotification
  Notification::TimeOff::CoachOutOfOffice
  Onboarding::EnsureTeenInvited
  Onboarding::MemberSupport
  Onboarding::PrimaryClinician
  OngoingEligibilityCheckJob
  PhoneDesk::Intake
  ServiceLineRecommendation::SchedulingUpdate
  TaskManagement::MemberNameChangedReminder
  TaskManagement::OverlappingAppointmentReminder
  TaskManagement::ReminderAssignment::CareGuideReminder
  TaskManagement::ReminderAssignment::CoachReminder
  TaskManagement::ReminderAssignment::MemberSupportReminder
  TaskManagement::ReminderAssignment::PrescriberReminder
  TaskManagement::ReminderAssignment::TherapistReminder
  TaskManagement::VerifyCoverageReminder
  Treatment::NeedSchedulingReminder
  WaitList::AppointmentScheduled
  SlotRecapture::CancellationHandler
  SlotRecapture::FilledDetector
]

def subscribe_all_wisper_event_listeners
  Wisper.clear unless Rails.env.production?

  # Global subscriptions
  Wisper.subscribe(EventTracker.new, prefix: true)
  Wisper.subscribe(Monitoring::GlobalListener.new, with: :track_metric)

  # Inline subscriptions
  # We need to eager load these classes so that subscriptions get set up
  REEF_EVENT_LISTENERS.map(&:constantize).each do |listener|
    listener.subscribe_to_registered_events
  end
end

Rails.application.reloader.to_prepare do
  subscribe_all_wisper_event_listeners
end
