# frozen_string_literal: true

class Staffers::Calendaring::TemplateCalendarComponent < ApplicationComponent
  def initialize(template:, step: nil, editable: true)
    @template = template
    @start_date = Date.current.beginning_of_week(:monday)
    @step = step.presence || default_step_size
    @editable = editable
    @time_zone = template.timezone

    # Always show 6 days (Monday through Saturday)
    @days = 6

    # Validate step size - only 15 and 30 minute steps are currently supported
    unless [15.minutes, 30.minutes].include?(@step)
      raise ArgumentError, "Step must be either 15 minutes or 30 minutes. Got: #{@step.to_i / 60} minutes"
    end
  end

  def time_range
    # Determine the overall time range from template regular hours
    return default_time_range if regular_hours.empty?

    earliest_start = regular_hours.map { |rh| time_from_hour_minute(rh.start_time_hour, rh.start_time_minute) }.min
    latest_end = regular_hours.map { |rh| time_from_hour_minute(rh.end_time_hour, rh.end_time_minute) }.max

    # Round to nearest hour for cleaner display
    start_hour = earliest_start.hour
    end_hour = latest_end.hour
    end_hour += 1 if latest_end.min > 0 # Round up if there are minutes

    time_from_hour_minute(start_hour, 0)..time_from_hour_minute(end_hour, 0)
  end

  def default_time_range
    # Default to 8 AM to 8 PM if no regular hours
    time_from_hour_minute(8, 0)..time_from_hour_minute(20, 0)
  end

  def time_from_hour_minute(hour, minute)
    # Use the start_date to ensure consistent time zone handling across the week
    # This prevents DST issues when the calendar spans DST transitions
    reference_date = @start_date
    Time.use_zone(@time_zone) do
      Time.zone.local(reference_date.year, reference_date.month, reference_date.day, hour, minute)
    end
  end

  def regular_hours
    @regular_hours ||= @template.template_regular_hours
  end

  def template_includes_saturday?
    # Saturday is day_of_week 6
    regular_hours.any? { |rh| rh.day_of_week == 6 }
  end

  def template_blocks_by_day
    @template_blocks_by_day ||= @template.template_blocks.includes(:template_regular_hours, template_block_type: :template_block_type_appointment_types).group_by(&:day_of_week)
  end

  def blocks_for_day(day_index)
    # Sunday = 0, Monday = 1, etc.
    day_of_week = (@start_date + day_index).wday
    template_blocks_by_day[day_of_week]&.sort_by(&:start_time) || []
  end

  def time_range_for_block(block, day_index)
    # Calculate the actual date for this day_index
    actual_date = @start_date + day_index

    # Create times on the actual date
    start_time = Time.use_zone(@time_zone) do
      Time.zone.local(actual_date.year, actual_date.month, actual_date.day,
        block.start_time_hour, block.start_time_minute)
    end

    duration_minutes = block.template_block_type.duration_minutes
    end_time = start_time + duration_minutes.minutes
    start_time..end_time
  end

  def slot_height_minutes
    @step.to_i / 60 # Convert seconds to minutes
  end

  def regular_hours_json
    # Format regular hours for JavaScript consumption
    # Group by day_of_week and convert to format the JS can use
    regular_hours.each_with_object({}) do |rh, hash|
      # Convert day_of_week to match JavaScript (0 = Sunday for both)
      hash[rh.day_of_week] ||= []
      hash[rh.day_of_week] << {
        start_hour: rh.start_time_hour,
        start_minute: rh.start_time_minute,
        end_hour: rh.end_time_hour,
        end_minute: rh.end_time_minute
      }
    end
  end

  erb_template <<~ERB
    <% if regular_hours.empty? %>
      <div class="flex items-center justify-center p-8 bg-gray-50 rounded-md border-2 border-dashed border-gray-300">
        <div class="text-center">
          <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <h3 class="mb-2 prism-text-medium!">No Working Hours Set</h3>
          <p class="text-gray-600">Please set hours before configuring time blocks</p>
        </div>
      </div>
    <% else %>
      <div data-controller="components--template-calendar-drag"
           data-components--template-calendar-drag-step-minutes-value="<%= slot_height_minutes %>"
           data-components--template-calendar-drag-start-hour-value="<%= time_range.begin.hour %>"
           data-components--template-calendar-drag-end-hour-value="<%= time_range.end.hour %>"
           data-components--template-calendar-drag-days-value="<%= @days %>"
           data-components--template-calendar-drag-editable-value="<%= @editable %>"
           data-components--template-calendar-drag-regular-hours-value="<%= html_escape(regular_hours_json.to_json) %>"
           data-components--template-calendar-drag-template-id-value="<%= @template.id %>">
        <%= render Staffers::Calendaring::AppointmentCalendarComponent.new(
          time_range: time_range,
          days: @days,
          time_zone: @time_zone,
          start_date: @start_date,
          step: @step,
          height: :compact
        ) do |calendar| %>
          <% calendar.with_header do %>
            <%= render Staffers::Calendaring::TemplateCalendarHeaderComponent.new(
              template: @template,
              start_date: @start_date,
              days: @days,
              row_span: 1
            ) %>
          <% end %>
          
          <% (0...@days).each do |day_index| %>
            <% blocks_for_day(day_index).each do |block| %>
              <% calendar.with_event(time_range: time_range_for_block(block, day_index)) do %>
                <%= render Staffers::Calendaring::TemplateBlockComponent.new(
                  template_block: block,
                  time_zone: @time_zone,
                  editable: @editable
                ) %>
              <% end %>
            <% end %>
          <% end %>
        <% end %>
      </div>
    <% end %>
  ERB
end
