# frozen_string_literal: true

require "rails_helper"

RSpec.describe Provider do
  describe "#accepting_patients_for?" do
    context "when provider lacks required capability in region" do
      it "returns false" do
        staffer = FactoryBot.create(:staffer)
        provider = Provider.new(staffer)

        result = provider.accepting_patients_for?(
          root_appointment_type: RootAppointmentType.coaching_session,
          region: Region.california,
          payer: nil
        )

        expect(result).to be false
      end
    end

    context "when provider has required capability in region" do
      context "when appointment does not require credentials" do
        it "returns true" do
          staffer = FactoryBot.create(:staffer)
          staffer.care_capabilities.create!(capability_id: Capability.coaching_ongoing.id, region: Region.california)
          provider = Provider.new(staffer)

          result = provider.accepting_patients_for?(
            root_appointment_type: RootAppointmentType.coaching_session,
            region: Region.california,
            payer: nil
          )

          expect(result).to be true
        end
      end

      context "when appointment requires credentials" do
        context "with nil payer" do
          it "bypasses credential check" do
            staffer = FactoryBot.create(:staffer)
            staffer.care_capabilities.create!(capability_id: Capability.therapy_ongoing.id, region: Region.new_york)
            provider = Provider.new(staffer)

            result = provider.accepting_patients_for?(
              root_appointment_type: RootAppointmentType.therapy_session,
              region: Region.new_york,
              payer: nil
            )

            expect(result).to be true
          end
        end

        context "with direct-to-consumer payer" do
          it "bypasses credential check" do
            staffer = FactoryBot.create(:staffer)
            staffer.care_capabilities.create!(capability_id: Capability.therapy_ongoing.id, region: Region.new_york)
            provider = Provider.new(staffer)
            payer = FactoryBot.create(:payer, slug: Contracts::Special::DIRECT_TO_CONSUMER_SLUG)

            result = provider.accepting_patients_for?(
              root_appointment_type: RootAppointmentType.therapy_session,
              region: Region.new_york,
              payer: payer
            )

            expect(result).to be true
          end
        end

        context "with real payer" do
          context "when provider lacks credentials for payer in region" do
            it "returns false" do
              staffer = FactoryBot.create(:staffer)
              staffer.care_capabilities.create!(capability_id: Capability.therapy_ongoing.id, region: Region.california)
              provider = Provider.new(staffer)
              payer = FactoryBot.create(:payer, slug: "test_payer")

              result = provider.accepting_patients_for?(
                root_appointment_type: RootAppointmentType.therapy_session,
                region: Region.california,
                payer: payer
              )

              expect(result).to be false
            end
          end

          context "when provider has credentials for payer in region" do
            it "returns true when no limits are in place" do
              staffer = FactoryBot.create(:staffer)
              staffer.care_capabilities.create!(capability_id: Capability.therapy_ongoing.id, region: Region.california)
              payer = FactoryBot.create(:payer, slug: "test_payer")
              FactoryBot.create(:staffer_credential, staffer: staffer, payer: payer, region_ids: [Region.california.id])
              provider = Provider.new(staffer)

              result = provider.accepting_patients_for?(
                root_appointment_type: RootAppointmentType.therapy_session,
                region: Region.california,
                payer: payer
              )

              expect(result).to be true
            end
          end
        end
      end

      context "when capability is not in NewPatientLimit::CAPABILITY_IDS" do
        it "returns true for coaching capability" do
          staffer = FactoryBot.create(:staffer)
          staffer.care_capabilities.create!(capability_id: Capability.coaching_ongoing.id, region: Region.california)
          provider = Provider.new(staffer)

          result = provider.accepting_patients_for?(
            root_appointment_type: RootAppointmentType.coaching_session,
            region: Region.california,
            payer: nil
          )

          expect(result).to be true
        end
      end

      context "when capability is in NewPatientLimit::CAPABILITY_IDS" do
        context "when no NewPatientLimit exists for staffer and capability" do
          it "returns true" do
            staffer = FactoryBot.create(:staffer)
            staffer.care_capabilities.create!(capability_id: Capability.therapy_ongoing.id, region: Region.california)
            provider = Provider.new(staffer)

            result = provider.accepting_patients_for?(
              root_appointment_type: RootAppointmentType.therapy_session,
              region: Region.california,
              payer: nil
            )

            expect(result).to be true
          end
        end

        context "when NewPatientLimit exists" do
          context "when limit blocks patient" do
            it "returns false when limit is zero" do
              staffer = FactoryBot.create(:staffer)
              staffer.care_capabilities.create!(capability_id: Capability.therapy_ongoing.id, region: Region.california)
              FactoryBot.create(:new_patient_limit, :capped, staffer: staffer, capability_id: Capability.therapy_ongoing.id)
              provider = Provider.new(staffer)

              result = provider.accepting_patients_for?(
                root_appointment_type: RootAppointmentType.therapy_session,
                region: Region.california,
                payer: nil
              )

              expect(result).to be false
            end

            it "returns false when region is restricted" do
              staffer = FactoryBot.create(:staffer)
              staffer.care_capabilities.create!(capability_id: Capability.therapy_ongoing.id, region: Region.california)
              FactoryBot.create(:new_patient_limit, staffer: staffer, capability_id: Capability.therapy_ongoing.id, region_ids: [Region.washington.id])
              provider = Provider.new(staffer)

              result = provider.accepting_patients_for?(
                root_appointment_type: RootAppointmentType.therapy_session,
                region: Region.california,
                payer: nil
              )

              expect(result).to be false
            end

            it "returns false when payer is restricted" do
              staffer = FactoryBot.create(:staffer)
              staffer.care_capabilities.create!(capability_id: Capability.therapy_ongoing.id, region: Region.california)
              allowed_payer = FactoryBot.create(:payer, slug: "allowed_payer")
              FactoryBot.create(:new_patient_limit, staffer: staffer, capability_id: Capability.therapy_ongoing.id, payer_slugs: [allowed_payer.slug])
              provider = Provider.new(staffer)
              different_payer = FactoryBot.create(:payer, slug: "different_payer")

              result = provider.accepting_patients_for?(
                root_appointment_type: RootAppointmentType.therapy_session,
                region: Region.california,
                payer: different_payer
              )

              expect(result).to be false
            end
          end

          context "when limit allows patient" do
            it "returns true when all conditions are met" do
              staffer = FactoryBot.create(:staffer)
              staffer.care_capabilities.create!(capability_id: Capability.therapy_ongoing.id, region: Region.california)
              FactoryBot.create(:new_patient_limit, staffer: staffer, capability_id: Capability.therapy_ongoing.id, limit: nil)
              provider = Provider.new(staffer)

              result = provider.accepting_patients_for?(
                root_appointment_type: RootAppointmentType.therapy_session,
                region: Region.california,
                payer: nil
              )

              expect(result).to be true
            end

            it "returns true when region is allowed" do
              staffer = FactoryBot.create(:staffer)
              staffer.care_capabilities.create!(capability_id: Capability.therapy_ongoing.id, region: Region.california)
              FactoryBot.create(:new_patient_limit, staffer: staffer, capability_id: Capability.therapy_ongoing.id, region_ids: [Region.california.id])
              provider = Provider.new(staffer)

              result = provider.accepting_patients_for?(
                root_appointment_type: RootAppointmentType.therapy_session,
                region: Region.california,
                payer: nil
              )

              expect(result).to be true
            end

            it "returns true when payer is allowed" do
              staffer = FactoryBot.create(:staffer)
              staffer.care_capabilities.create!(capability_id: Capability.therapy_ongoing.id, region: Region.california)
              allowed_payer = FactoryBot.create(:payer, slug: "allowed_payer")
              FactoryBot.create(:staffer_credential, staffer: staffer, payer: allowed_payer, region_ids: [Region.california.id])
              FactoryBot.create(:new_patient_limit, staffer: staffer, capability_id: Capability.therapy_ongoing.id, payer_slugs: [allowed_payer.slug])
              provider = Provider.new(staffer)

              result = provider.accepting_patients_for?(
                root_appointment_type: RootAppointmentType.therapy_session,
                region: Region.california,
                payer: allowed_payer
              )

              expect(result).to be true
            end

            it "returns true when DTC is allowed in payer restrictions" do
              staffer = FactoryBot.create(:staffer)
              staffer.care_capabilities.create!(capability_id: Capability.therapy_ongoing.id, region: Region.california)
              FactoryBot.create(:new_patient_limit, staffer: staffer, capability_id: Capability.therapy_ongoing.id, payer_slugs: [Contracts::Special::DIRECT_TO_CONSUMER_SLUG])
              provider = Provider.new(staffer)

              result = provider.accepting_patients_for?(
                root_appointment_type: RootAppointmentType.therapy_session,
                region: Region.california,
                payer: nil
              )

              expect(result).to be true
            end
          end
        end
      end
    end

    context "with appointment_type_mode parameter" do
      context "when mode is in_person" do
        it "only checks capability in clinic region" do
          clinic = FactoryBot.create(:clinic, region: Region.california)
          staffer = FactoryBot.create(:staffer, clinic: clinic)
          staffer.care_capabilities.create!(capability_id: Capability.coaching_ongoing.id, region: Region.california)
          provider = Provider.new(staffer)

          result = provider.accepting_patients_for?(
            root_appointment_type: RootAppointmentType.coaching_session,
            region: Region.new_york,
            payer: nil,
            appointment_type_mode: :in_person
          )

          expect(result).to be true
        end
      end

      context "when mode is video" do
        it "only checks capability in requested region" do
          clinic = FactoryBot.create(:clinic, region: Region.california)
          staffer = FactoryBot.create(:staffer, clinic: clinic)
          staffer.care_capabilities.create!(capability_id: Capability.coaching_ongoing.id, region: Region.new_york)
          provider = Provider.new(staffer)

          result = provider.accepting_patients_for?(
            root_appointment_type: RootAppointmentType.coaching_session,
            region: Region.new_york,
            payer: nil,
            appointment_type_mode: :video
          )

          expect(result).to be true
        end
      end

      context "when mode is invalid" do
        it "raises an error" do
          staffer = FactoryBot.create(:staffer)
          provider = Provider.new(staffer)

          expect {
            provider.accepting_patients_for?(
              root_appointment_type: RootAppointmentType.coaching_session,
              region: Region.california,
              payer: nil,
              appointment_type_mode: :invalid
            )
          }.to raise_error("Invalid appointment type mode: invalid")
        end
      end
    end
  end
end
